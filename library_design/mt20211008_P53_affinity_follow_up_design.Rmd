---
title: "XXX"
author: 
  - name: "Max Trauernicht"
    email: "m.trauernicht@nki.nl"
    affiliation: "Netherlands Cancer Institute - van Steensel lab"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
---

---

### Aim
I want to know if the chosen P53 binding sites for my reporter assay correlate with upregulated genes stimulated with Nutlin-3a in MCF7 cells.


---

## Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
    $(document).ready(function() {
      $items = $('div#TOC li');
      $items.each(function(idx) {
        num_ul = $(this).parentsUntil('#TOC').length;
        $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
      });

    });
</script>

```{css, echo = FALSE}
div.sourceCode {
  overflow-x: hidden;
}
```

### Libraries
```{r setup, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(blogdown)
library(dplyr)
```

### Custom functions

```{r, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
```


### Load data

```{r}
## Load in the previously designed sequences 
tf.df <- read_csv2("/DATA/usr/m.trauernicht/projects/P53_reporter_scan/data/library_design/output/tf_df_complete.csv") %>%
  filter(tf == "Trp53", position == 0, promoter == "mCMV", background == 1, oligo.barcode == 1, spacing == 1 | spacing == 7, 
         affinity_pos1 == 0, affinity_pos2 == 0, affinity_pos3 == 0, affinity_pos4 == 0) %>%
  dplyr::select(tf, promoter, spacing, primer1_seq, motif3, space3, motif4, distance.seq, 
                promoter_sequence, s1_primer, barcode, primer2_seq) %>%
  unique() %>%
  mutate(tf = "P53")


## Create the desired data frame by adding space for 14 motifs and different spacer-positioning combinations
ddG <- data.frame("affinity_pos3" = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,1:14, 1:14),
                  "affinity_pos4" = c(1:14, 1:14,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                  "tf" = "P53")
tf.df <- merge(tf.df, ddG)
  

## Fill in the correct motif sequences
p53_affinities <- read_csv2("/DATA/usr/m.trauernicht/projects/P53_reporter_scan/data/library_design/p53_fimo_sequences_affinity.csv")
zero <- data.frame("ddG" = 0, "Motif" = "")
p53_affinities <- rbind(p53_affinities, zero)

for (i in unique(p53_affinities$ddG)) {
  tf.df$motif3[tf.df$affinity_pos3 == i] <- p53_affinities$Motif[p53_affinities$ddG == i]
  tf.df$motif4[tf.df$affinity_pos4 == i] <- p53_affinities$Motif[p53_affinities$ddG == i]
}


## Add number of motifs
tf.df$motifs <- 2
tf.df$motifs[tf.df$motif3 == ""] <- 1
tf.df$motifs[tf.df$motif4 == ""] <- 1

## Add barcodes (select from previous script the ones that were used for similar active reporters)
barcode <- read_csv2("/DATA/usr/m.trauernicht/projects/P53_reporter_scan/data/library_design/output/tf_df_complete.csv") %>%
  filter(tf == "Trp53", position == 0, promoter == "mCMV", background == 1, spacing == 1 | spacing == 7) %>%
  dplyr::select(barcode) %>%
  unique()
barc <- slice_sample(barcode, n = nrow(tf.df))
tf.df$barcode <- barc$barcode


## Paste together sequence names and sequences and remove unwanted double sequences with only one motif
tf.df$seq.name <- paste(tf.df$tf, "x", tf.df$motifs, tf.df$promoter, "s", tf.df$spacing, "aff1", tf.df$affinity_pos3, "aff2", tf.df$affinity_pos4, sep = "_")
tf.df$seq.text <- paste(tf.df$primer1_seq, tf.df$motif3, tf.df$space3, tf.df$motif4, tf.df$distance.seq, tf.df$promoter_sequence, tf.df$s1_primer, tf.df$barcode, tf.df$primer2_seq, sep = "")
tf.df$nchar <- nchar(tf.df$seq.text)
tf.df2 <- tf.df[tf.df$spacing == 1 & tf.df$motif3 == "",]
tf.df3 <- tf.df[tf.df$spacing == 1 & tf.df$motif4 == "",]
tf.df <- tf.df[!tf.df$seq.name %in% tf.df2$seq.name,]
tf.df <- tf.df[!tf.df$seq.name %in% tf.df3$seq.name,]


## Export
tf.df.export <- tf.df %>%
  dplyr::select(seq.name, seq.text)
#write.csv(tf.df.export, "/DATA/usr/m.trauernicht/projects/SuRE_deep_scan_trp53_gr/data/library_design/output/mt20211008_follow_up_library_p53_affinity.csv")
```

---

## Visualisation

```{r, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}



```

---

## Results
```{r, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
```


### Exporting potential data
```{r, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
```


# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

