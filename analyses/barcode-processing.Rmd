---
title: "Barcode processing - P53 Deep Scan"
author: "Max Trauernicht"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
  #   toc: true
  #   toc_float: true
  #   code_folding: show
  # editor_options:
  #   chunk_output_type: console
---

*knitr document van Steensel lab*

# TF reporter barcode processing - P53 Deep Scan

## Introduction
pMT06 was transfected into various cell types and mRNA barcode counts were sequenced together with pMT06 pDNA counts. In two different sequencing runs, data for all P53 reporters (1/2 of the library) was collected, and will be analyzed here. The GR reporters will be analyzed seperately. 

```{r setup, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(data.table)
library(plyr)
library(stringr)
library(ggpubr)
library(GGally)
library(vwr)
library(dplyr)
library(tibble)
library(plotly)
library(ggbeeswarm)
library(haven)
library(readr)
library(parallel)
library(RColorBrewer)
library(gridExtra)
library(pheatmap)
library(shiny)
library(factoextra)
library(ggbiplot)
library(ggpointdensity)
library(viridis)
```


```{r out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
#Custom functions
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}


# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {

  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y, "pairwise.complete.obs")
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)

  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }

  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())

  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]

  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }

  p <- p +
    theme(panel.background = element_rect(fill = corCol))

  return(p)
}
```

```{r knits setup, echo=FALSE, warning= FALSE, message=FALSE}
# Prepare output 
library(knitr)
filename <- SetFileName("_figures","mt")
dir.create(paste("results/", filename, sep = ""), showWarnings = FALSE)
opts_chunk$set(fig.width = 6, fig.height = 4, 
               dev=c('png', 'pdf'), fig.path = file.path(paste("results/", filename, "/", sep = ""))) 
pdf.options(useDingbats = FALSE)
```


```{r data import, fig.width=10, fig.height=7, fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
# Import barcode counts per condition - gcf6210
bc_files = list.files('/DATA/usr/m.trauernicht/projects/SuRE_deep_scan_trp53_gr/data/gcf6210/results/',
                       full.names=T, patter='*_barcode_counts.tsv')
bc_list <- lapply(bc_files, fread, header = FALSE)
names(bc_list)<- gsub('.*//6210_[0-9]{1,2}_(.*?)_[CGAT]{6}.*_barcode_counts.tsv', 
                                    '\\1', 
                                    bc_files)
# Import barcode counts per condition - gcf6301
bc_files = list.files('/DATA/usr/m.trauernicht/projects/SuRE_deep_scan_trp53_gr/data/gcf6301/results/',
                       full.names=T, patter='*_barcode_counts.tsv')
bc_list_2 <- lapply(bc_files, fread, header = FALSE)
names(bc_list_2)<- gsub('.*//6301_[0-9]{1,2}_(.*?)_[CGAT]{6}.*_barcode_counts.tsv',
                                    '\\1',
                                    bc_files)
bc_list <- c(bc_list, bc_list_2)

# Import barcode annotation
bc_annotation <- read.csv2("/DATA/usr/m.trauernicht/projects/SuRE_deep_scan_trp53_gr/data/library_design/output/tf_df_complete.csv", header = T) %>% 
  dplyr::select(barcode, tf, oligo.barcode, spacing, promoter,
         position, distance, background, affinity_pos1,
         affinity_pos2, affinity_pos3, affinity_pos4, seq.name) %>%
  setnames("seq.name", "reporter_id")
```

## Analysis
```{r cluster_compare, fig.width=10, fig.height=7, fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
# Generate long dfs
for (i in 1:length(bc_list)) {
  if (i == 1) {
  bc_df <- data.frame(bc_list[i])
  bc_df[3] <- names(bc_list[i])
  names(bc_df) <- c("barcode", "count", "name")
  bc_df <- reshape2::dcast(bc_df, barcode ~ name, value.var = "count")
  }
  else {
  bc_df_i <- data.frame(bc_list[i])
  bc_df_i[3] <- names(bc_list[i])
  names(bc_df_i) <- c("barcode", "count", "name")
  bc_df_i <- reshape2::dcast(bc_df_i, barcode ~ name, value.var = "count")
  bc_df <- merge(bc_df, bc_df_i, all = T)
  }
}

# Match designed barcodes
bc_df <- merge(bc_df, bc_annotation, all = T)


# Convert to long df
bc_df <- melt(bc_df, id.vars = c("barcode", "tf", "oligo.barcode", "spacing", "distance", "promoter", "background", "position", 
                                 "affinity_pos1", "affinity_pos2", "affinity_pos3", "affinity_pos4", "reporter_id"),
              variable.name = "condition", value.name = "starcode_counts", as.is = T)
bc_df$starcode_counts[is.na(bc_df$starcode_counts)] <- 0


# Rename conditions
bc_df$condition <- gsub("_pMT06", "", bc_df$condition)

# Remove pMT02 data
bc_df <- bc_df[-grep("pMT02", bc_df$condition),]

# Only keep P53 data
bc_df <- bc_df[-grep("Gr", bc_df$tf),]
bc_df$tf <- gsub("Trp", "P", bc_df$tf)
bc_df
```


### Data exploration
```{r read_distribution, fig.width=10, fig.height=7, fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
# First compute reads per million to estimate the relative counts in their respective sample
for (i in unique(bc_df$condition)) {
  bc_df$rpm[bc_df$condition == i] <- (bc_df$starcode_counts[bc_df$condition == i] + 1) / # Adds a pseudocount of 1
    sum(bc_df$starcode_counts[bc_df$condition == i]) *1e6
}

# I want to show the following:
## 1: Read distribution of matched barcodes vs. unmatched barcode
bc_df_reads <- bc_df[!is.na(bc_df$tf),] 
bc_df_reads$seq_run <- "1"
bc_df_reads$seq_run[grep("r[1-3]{1}$", bc_df_reads$condition)] <- "2"
bc_df_reads <- bc_df_reads %>% 
  dplyr::group_by(seq_run) %>% 
  mutate(seq_sum = sum(starcode_counts))
bc_df_reads <- bc_df_reads %>% 
  dplyr::group_by(condition) %>% 
  mutate(sum = (sum(starcode_counts) / seq_sum)*100)

plot_ly(bc_df_reads[bc_df_reads$seq_run == "1",] %>% dplyr::select(condition, sum) %>% unique(), x = ~condition, y = ~sum, type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Percentage of reads in sequencing run 1",
         yaxis = list(title = "Percentage of matched reads"),
         xaxis = list(title = "Condition"))
plot_ly(bc_df_reads[bc_df_reads$seq_run == "2",] %>% dplyr::select(condition, sum) %>% unique(), x = ~condition, y = ~sum, type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Percentage of reads in sequencing run 2",
         yaxis = list(title = "Percentage of matched reads"),
         xaxis = list(title = "Condition"))

ggplot(bc_df[!is.na(bc_df$tf),], aes(x = tf, y = rpm)) +
  geom_jitter(alpha = 0.1) +
  theme_bw() +
  ylim(0,2500) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 6)) +
  facet_wrap(~condition)

bc_df_2 <- bc_df[bc_df$rpm <= 250,]
bc_df_2 <- bc_df_2[bc_df_2$rpm >= 0.5,]
bc_df_2 <- bc_df_2[!is.na(bc_df_2$tf),]

ggplot(bc_df_2, aes(x = rpm)) +
  geom_histogram(binwidth = 10) +
  theme_bw() +
  xlim(0,250)+
  ylim(0,1000)+
  facet_wrap(~condition)+
  theme(strip.background =element_rect(fill="#D6D5C9"))

ggplot(bc_df[bc_df$rpm >= 1000 & !is.na(bc_df$tf),], aes(x = rpm)) +
    geom_histogram(binwidth = 40) +
    theme_bw() +
    xlim(1000,2000)+
    ylim(0,25)+
    facet_wrap(~condition)+
    theme(strip.background =element_rect(fill="#D6D5C9"))

n_highly_expressed <- data.frame("condition" = unique(bc_df$condition),
                                 "n_bc" = "", stringsAsFactors=FALSE)
for (i in unique(bc_df$condition)) {
  n_highly_expressed$n_bc[n_highly_expressed$condition == i] <- 
    length(bc_df$barcode[bc_df$rpm > 1000 & bc_df$condition == i])
}

plot_ly(n_highly_expressed, x = ~condition, y = ~as.numeric(n_bc), type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Highly expressed barcodes",
         yaxis = list(title = "Number of barcodes with > 500 rpm"),
         xaxis = list(title = "Condition"))

n_highly_expressed <- data.frame("condition" = unique(bc_df$condition),
                                 "n_bc" = "", stringsAsFactors=FALSE)
bc_df_2 <- bc_df[grep("random", bc_df$tf),]
for (i in unique(bc_df$condition)) {
  n_highly_expressed$n_bc[n_highly_expressed$condition == i] <- 
    length(bc_df_2$barcode[bc_df_2$rpm > 300 & bc_df_2$condition == i])
}

plot_ly(n_highly_expressed, x = ~condition, y = ~as.numeric(n_bc), type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Highly expressed barcodes from random motifs",
         yaxis = list(title = "Number of barcodes with > 300 rpm"),
         xaxis = list(title = "Condition"))

```


```{r cutoff_read_distribution, fig.width=10, fig.height=7, fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
## 2: How many barcodes can I find back at which cutoff? + What is the percentage of barcode reads that match the design at which cutoff?
## Identify the unmapped fraction
bc_fraction <- data.frame("condition" = unique(bc_df$condition),
                          "bcs_found" = "", stringsAsFactors=FALSE)
rpm_cutoff <- data.frame("cutoff" = seq(0.0001,15,0.5), stringsAsFactors=FALSE)
bc_fraction <- merge(bc_fraction, rpm_cutoff)

for (i in unique(bc_fraction$cutoff)) {
  for (j in unique(bc_df$condition)) {
    bc_n <- bc_df[bc_df$rpm >= i & bc_df$condition == j & bc_df$tf == "P53" & !is.na(bc_df$tf),]
    bc_fraction$bcs_found[bc_fraction$cutoff == i & bc_fraction$condition == j] <- nrow(bc_n)/
      nrow(bc_annotation[bc_annotation$tf == "Trp53",]) *100
  }
}



## How many reads match to designed barcodes?
bc_reads <- data.frame("condition" = unique(bc_df$condition),
                          "bc_reads" = "", stringsAsFactors=FALSE)
bc_reads <- merge(bc_reads, rpm_cutoff)

for (i in unique(bc_reads$cutoff)) {
  for (j in unique(bc_df$condition)) {
    bc_n <- bc_df[bc_df$rpm >= i & bc_df$condition == j,]
    bc_n <- bc_n[-grep("random",bc_n$tf),]
    bc_reads$bc_reads[bc_reads$cutoff == i & bc_reads$condition == j] <- sum(bc_n$rpm[!is.na(bc_n$tf)])/
      sum(bc_n$rpm) *100
  }
}

bc_fraction <- merge(bc_fraction, bc_reads)
bc_fraction$bcs_found <- as.numeric(bc_fraction$bcs_found)
bc_fraction$bc_reads <- as.numeric(bc_fraction$bc_reads)

#c("#1B998B", "#2D3047", "#FF9B71", "#ECDD7B")
# Plot to evaluate data quality per cutoff
ggplot(bc_fraction) +
  geom_point(aes(x = cutoff, y = bcs_found), color = '#1B998B', size = 1) +
  geom_line(aes(x = cutoff, y = bcs_found), color = '#1B998B', size = 1) +
  geom_point(aes(x = cutoff, y = bc_reads), color = 'black', size = 1) +
  geom_line(aes(x = cutoff, y = bc_reads), color = 'black', size = 1) +
  theme_bw()+
  xlab("rpm cutoff")+
  ylab("total barcodes (green) and matched barcode reads (black) detected (%)")+
  facet_wrap(~condition)+
  theme(strip.background =element_rect(fill="#D6D5C9"))
```


```{r pDNA_cDNA_correlation, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## 3: What is the correlation of the 24 cDNA bc counts with the pDNA bc counts? 
pDNA <- data.frame("pDNA" = bc_df$rpm[bc_df$condition == "pMT06_pDNA_rep1"],
                   "barcode"= bc_df$barcode[bc_df$condition == "pMT06_pDNA_rep1"], stringsAsFactors=FALSE)
bc_df_2 <- merge(pDNA, bc_df, all = T)

ggplot(bc_df_2, aes(x = pDNA, y = rpm)) +
  geom_bin2d(bins = 100)+
  xlim(0,1000) +
  ylim(0,1000)+
  theme_bw()+
  facet_wrap(~condition)

# How do the highly represented pDNA_barcodes deviate from the barcode reads in the cDNA data? 
## I do this because the correlation of lowly represented barcodes is very noisy
pDNA_bias <- data.frame("condition" = unique(bc_df_2$condition),
                        "cor" = "", stringsAsFactors = F)
for (i in unique(bc_df_2$condition)) {
  pDNA_bias$cor[pDNA_bias$condition == i] <- cor(bc_df_2$rpm[bc_df_2$pDNA >= 250 & bc_df_2$condition == i], 
                                                 bc_df_2$pDNA[bc_df_2$pDNA >= 250 & bc_df_2$condition == i])
}

plot_ly(pDNA_bias, x = ~condition, y = ~as.numeric(cor), type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "pDNA-cDNA correlation of highly represented barcodes",
         yaxis = list(title = "Correlation of pDNA vs. cDNA read counts (only barcodes with >250 pDNA counts)"),
         xaxis = list(title = "Condition"))

# Old vs new pDNA data
ggplot(bc_df_2[bc_df_2$condition == "pMT06-v2_pDNA_2" & bc_df_2$tf == "P53",], aes(x = pDNA, y = rpm)) +
    geom_pointdensity(show.legend = F)+
    theme_bw()+
    theme(text = element_text(size=14)) +
    xlab("old pDNA data (e.cloni)")+
    ylab("new pDNA data (clonecatcher)")+
    ggtitle("Old vs. new pDNA data")+
    scale_color_viridis()
```



```{r replicate_correlation_rpm, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## 4: Correlation plots of the replicates
## Combine replicates of normalized data in 3 different columns
bc_df$rep <- gsub(".*_(.*$)","\\1",bc_df$condition)
bc_df_rep <- bc_df[!is.na(bc_df$tf),] %>% dplyr::select(rep, rpm, reporter_id, condition) %>% unique()
bc_df_rep$condition <- gsub("(.*?)_rep[1-3]$", "\\1", bc_df_rep$condition)
bc_df_rep$condition <- gsub("(.*?)_r[1-3]$", "\\1", bc_df_rep$condition)
rep1 <- bc_df_rep[bc_df_rep$rep == "rep1",] %>% 
  dplyr::select(-rep) %>% 
  setnames("rpm", "rep1")
rep2<- bc_df_rep[bc_df_rep$rep == "rep2",] %>% 
  dplyr::select(-rep) %>% 
  setnames("rpm", "rep2")
rep3 <- bc_df_rep[bc_df_rep$rep == "rep3",] %>% 
  dplyr::select(-rep) %>% 
  setnames("rpm", "rep3")
r1 <- bc_df_rep[bc_df_rep$rep == "r1",] %>% 
  dplyr::select(-rep) %>% 
  setnames("rpm", "r1")
r2 <- bc_df_rep[bc_df_rep$rep == "r2",] %>% 
  dplyr::select(-rep) %>% 
  setnames("rpm", "r2")

bc_df_rep <- Reduce(function(x, y) merge(x, y, all = T), list(rep1, rep2, rep3, r1, r2))

# Correlation matrix plot
n <- sample(1:nrow(bc_df_rep), 5000)
boundaries <- seq(from = 0.8, by = 0.05, length.out = 4)
for (i in unique(bc_df_rep$condition)){
  plt <- ggpairs(bc_df_rep[bc_df_rep$condition == i,] %>% dplyr::select(rep1, rep2, rep3, r1, r2),
               upper = list(continuous = corColor),
               lower = list(continuous = function(data, mapping, ...) {
                   ggally_points(data = data[n, ], mapping = mapping, alpha = 0.1, size = 0.5) +
                   geom_abline(slope = 1, lty = "dashed", col = "red") +
                   theme_bw()}),
               diag = list(continuous = function(data, mapping, ...) {
                   ggally_densityDiag(data = data, mapping = mapping, alpha = 0.3, fill = "red") +
                   theme_bw()})) +
  ggtitle(paste("Correlation Between Replicates, Condition:", i)) +
  theme(text = element_text(size = 20)) +
  xlab("Reporter activity") +
  ylab("Reporter activity") + 
  theme_light()
  
  print(plt)
}
```

**Stuff learned from above figures:**  
Some samples can be excluded from further analysis because they don't contain useful information, these samples are:
MCF7-KO-DMSO: rep2, rep1(?), r2(?)
MCF7-KO-Nutlin: rep2, rep3(?), r1
MCF7-WT-DMSO: rep2, rep3
MCF7-WT-Nutlin: rep3
A549-Dex-1: r1
mES-N2B27-HQ: rep1
mES-N2B27-RA: rep1, rep2


### Normalization of barcode counts:
Divide cDNA barcode counts through pDNA barcode counts, if more than 30 pDNA counts for that barcode
```{r normalization, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
# Normalize data using pDNA data

# Remove all non-matching reads now
bc_df <- bc_df[!is.na(bc_df$tf),]

# Add pDNA data as separate column
pDNA <- bc_df[grep("pDNA", bc_df$condition),] %>% 
  dplyr::select(barcode, condition, rpm) %>% 
  unique() %>%
  dcast(barcode ~ condition) %>%
  mutate(pDNA_counts_rpm = (pMT06_pDNA_rep1 + pMT06_pDNA_rep2 + pMT06_pDNA + `pMT06-v2_pDNA_1` + `pMT06-v2_pDNA_2`) / 5) %>%
  dplyr::select(barcode, pDNA_counts_rpm)
bc_df <- merge(pDNA, bc_df)

## Compute activity by dividing cDNA bc counts through pDNA bc counts
bc_df$activity <- bc_df$rpm / bc_df$pDNA_counts_rpm
```

### Characterize activities
```{r tf_activity, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
# Histogram - show only high activities per condition
ggplot(bc_df[bc_df$activity >= 5,], aes(x = activity)) +
    geom_histogram(binwidth = 1) +
    theme_bw() +
    xlim(5,15)+
    facet_wrap(~condition)+
    theme(strip.background =element_rect(fill="#D6D5C9"))

# Barplot - show how many active reporters there are per condition
bc_df_2 <- bc_df %>%
  filter(activity >= 4) %>%
  group_by(condition) %>%
  mutate(active_reporters = length(unique(barcode)))

plot_ly(bc_df_2 %>% 
          dplyr::select(condition, active_reporters) %>% 
          unique(), 
        x = ~condition, y = ~active_reporters, type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Number of highly active barcodes",
         yaxis = list(title = "Barcodes with cDNA/pDNA > 4"),
         xaxis = list(title = "Condition"))

# Barplot counting high activity barcodes from random motifs
bc_df_2 <- bc_df %>%
  filter(activity >= 4,
         str_detect(tf, "random")) %>%
  group_by(condition) %>%
  mutate(active_reporters = length(unique(barcode))) %>%
  dplyr::select(condition, active_reporters) %>%
  unique()

plot_ly(bc_df_2, x = ~condition, y = ~as.numeric(active_reporters), type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Highly active barcodes from random motifs",
         yaxis = list(title = "Number of barcodes with activity > 4"),
         xaxis = list(title = "Condition"))

# Correlation activities vs. pDNA data
ggplot(bc_df, aes(x = pDNA_counts_rpm, y = activity)) +
  geom_bin2d(bins = 100)+
  ylim(0,10)+
  theme_bw()+
  facet_wrap(~condition)

# Plot number of barcodes with activity > 3 and high pDNA count
bc_df_2 <- bc_df %>%
  filter(activity >= 3) %>%
  filter(pDNA_counts_rpm >= 200) %>%
  group_by(condition) %>%
  mutate(active_reporters = length(unique(barcode)))

plot_ly(bc_df_2 %>% 
          dplyr::select(condition, active_reporters) %>% 
          unique(), 
        x = ~condition, y = ~active_reporters, type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Number of highly active barcodes",
         yaxis = list(title = "Barcodes with cDNA/pDNA > 4"),
         xaxis = list(title = "Condition"))

```


```{r compare_activities, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
## 4: Correlation plots of the replicates
## Combine replicates of normalized data in 3 different columns
bc_df_rep <- bc_df[!is.na(bc_df$tf),] %>% dplyr::select(rep, activity, reporter_id, condition) %>% unique()
bc_df_rep$condition <- gsub("(.*?)_rep[1-3]$", "\\1", bc_df_rep$condition)
bc_df_rep$condition <- gsub("(.*?)_r[1-3]$", "\\1", bc_df_rep$condition)
rep1 <- bc_df_rep[bc_df_rep$rep == "rep1",] %>% 
  dplyr::select(-rep) %>% 
  setnames("activity", "rep1")
rep2<- bc_df_rep[bc_df_rep$rep == "rep2",] %>% 
  dplyr::select(-rep) %>% 
  setnames("activity", "rep2")
rep3 <- bc_df_rep[bc_df_rep$rep == "rep3",] %>% 
  dplyr::select(-rep) %>% 
  setnames("activity", "rep3")
r1 <- bc_df_rep[bc_df_rep$rep == "r1",] %>% 
  dplyr::select(-rep) %>% 
  setnames("activity", "r1")
r2 <- bc_df_rep[bc_df_rep$rep == "r2",] %>% 
  dplyr::select(-rep) %>% 
  setnames("activity", "r2")

bc_df_rep <- Reduce(function(x, y) merge(x, y, all = T), list(rep1, rep2, rep3, r1, r2))

# Correlation matrix plot
n <- sample(1:nrow(bc_df_rep), 5000)
boundaries <- seq(from = 0.8, by = 0.05, length.out = 4)
for (i in unique(bc_df_rep$condition)){
  plt <- ggpairs(bc_df_rep[bc_df_rep$condition == i,] %>% dplyr::select(rep1, rep2, rep3, r1, r2),
               upper = list(continuous = corColor),
               lower = list(continuous = function(data, mapping, ...) {
                   ggally_points(data = data[n, ], mapping = mapping, alpha = 0.1, size = 0.5) +
                   geom_abline(slope = 1, lty = "dashed", col = "red") +
                   theme_bw()}),
               diag = list(continuous = function(data, mapping, ...) {
                   ggally_densityDiag(data = data, mapping = mapping, alpha = 0.3, fill = "red") +
                   theme_bw()})) +
  ggtitle(paste("Correlation Between Replicates, Condition:", i)) +
  theme(text = element_text(size = 20)) +
  xlab("Reporter activity") +
  ylab("Reporter activity") + 
  theme_light()
  
  print(plt)
}
```


```{r out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
# First identify and remove outlier barcodes - this removes the noise created by faulty barcode clustering etc. 
## Calculate mean and SD for each reporter
bc_df_cDNA <- bc_df[-grep("pDNA", bc_df$condition),]
bc_df_cDNA$reporter_id <- gsub(".{5}$", "", bc_df_cDNA$reporter_id)
bc_df_cDNA$reporter_activity <- ave(bc_df_cDNA$activity, bc_df_cDNA$reporter_id, 
                                bc_df_cDNA$condition, FUN =
                                  function(x) mean(x))
bc_df_cDNA$reporter_activity_sd <- ave(bc_df_cDNA$activity, bc_df_cDNA$reporter_id, 
                              bc_df_cDNA$condition,  FUN =
                                  function(x) sd(x))

# ## Remove data points that are 2xSD away from the mean
# bc_df_cDNA$upper_activity <- bc_df_cDNA$reporter_activity + (1.75 * bc_df_cDNA$reporter_activity_sd)
# bc_df_cDNA$lower_activity <- bc_df_cDNA$reporter_activity - (1.75 * bc_df_cDNA$reporter_activity_sd)
# bc_df_cDNA_filt <- bc_df_cDNA %>%
#   mutate(outlier = "No")
# bc_df_cDNA_filt$outlier[bc_df_cDNA_filt$activity >= bc_df_cDNA_filt$upper_activity | 
#                                 bc_df_cDNA_filt$activity <= bc_df_cDNA_filt$lower_activity] <- "Yes"

## Remove reporters with a higher SD than the mean activity
bc_df_cDNA_filt <- bc_df_cDNA %>%
  mutate(outlier = "No")
bc_df_cDNA_filt$outlier[bc_df_cDNA_filt$reporter_activity_sd >= (bc_df_cDNA_filt$reporter_activity)] <- "Yes"

## Plot the fraction of outliers per sample
n_outlier <- bc_df_cDNA_filt %>%
          dplyr::select(outlier, condition, reporter_id) %>%
          filter(outlier == "Yes") %>%
          unique() %>% 
          group_by(condition) %>%
          mutate(n_outlier = length(outlier)) %>%
          dplyr::select(-outlier, -reporter_id) %>%
          unique()
bc_df_cDNA_filt <- merge(bc_df_cDNA_filt, n_outlier)

plot_ly(bc_df_cDNA_filt %>%
          dplyr::select(n_outlier, condition) %>%
          unique(),
        x = ~condition, y = ~n_outlier, type = 'bar',
             marker = list(color = '#D6D5C9',
                           line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Reporters with SD > mean activity per condition",
         yaxis = list(title = "Number of outliers"),
         xaxis = list(title = "Condition"))
  
## Only keep conditions with low noise levels
bc_df_cDNA_filt <- bc_df_cDNA_filt %>%
  filter(n_outlier < 200)

## Recalculate mean and sd
bc_df_cDNA_filt$reporter_activity <- ave(bc_df_cDNA_filt$activity, bc_df_cDNA_filt$reporter_id, 
                                bc_df_cDNA_filt$condition, FUN =
                                  function(x) mean(x))
bc_df_cDNA_filt$reporter_activity_sd <- ave(bc_df_cDNA_filt$activity, bc_df_cDNA_filt$reporter_id, 
                              bc_df_cDNA_filt$condition,  FUN =
                                  function(x) sd(x))
```






```{r out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
# Annotate the mutated motif of each TF
bc_df_cDNA_filt$neg_ctrls <- "No"
bc_df_cDNA_filt$neg_ctrls[grep("random", bc_df_cDNA_filt$tf)] <- "Yes"

# Annotate random promoter control
bc_df_cDNA_filt$rand_promoter <- "No"
bc_df_cDNA_filt$rand_promoter[grep("random", bc_df_cDNA_filt$promoter)] <- "Yes"
```



### Calculate correlations between technical replicates
```{r technical_replicate_correlations, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Combine replicates in 5 different columns
bc_df_rep <- bc_df_cDNA_filt %>% 
  filter(rand_promoter == "No", outlier == "No") %>%
  dplyr::select(oligo.barcode, activity, tf, condition, reporter_id, pDNA_counts_rpm) %>%
  mutate(pDNA_counts_rpm = ave(pDNA_counts_rpm, reporter_id, FUN = function(x) min(x))) %>% unique()
rep1 <- bc_df_rep[bc_df_rep$oligo.barcode == 1,] %>% dplyr::select(-oligo.barcode) %>% setnames("activity", "bc1")
rep2 <- bc_df_rep[bc_df_rep$oligo.barcode == 2,] %>% dplyr::select(-oligo.barcode) %>% setnames("activity", "bc2")
rep3 <- bc_df_rep[bc_df_rep$oligo.barcode == 3,] %>% dplyr::select(-oligo.barcode) %>% setnames("activity", "bc3")
rep4 <- bc_df_rep[bc_df_rep$oligo.barcode == 4,] %>% dplyr::select(-oligo.barcode) %>% setnames("activity", "bc4")
rep5 <- bc_df_rep[bc_df_rep$oligo.barcode == 5,] %>% dplyr::select(-oligo.barcode) %>% setnames("activity", "bc5")

bc_df_rep <-  Reduce(function(x, y) merge(x, y, all=TRUE), list(rep1, rep2, rep3, rep4, rep5))
bc_df_rep <- bc_df_rep[rowSums(is.na(bc_df_rep)) != ncol(bc_df_rep), ]

## Compute the correlation between two technical replicates for each pDNA cutoff, separately for each TF
cor_df <- data.frame("rpm_cutoff"  = seq(0,100,1), "cor" = "", stringsAsFactors=FALSE)
cor_df <- merge(unique(bc_df_rep$tf), cor_df)

for (i in unique(cor_df$rpm_cutoff)) {
  for (j in unique(cor_df$x)) {
    x <- bc_df_rep[bc_df_rep$pDNA_counts_rpm > i & bc_df_rep$tf == j,]
    if (nrow(x) == 0) {
      cor_df$cor[cor_df$rpm_cutoff == i & cor_df$x == j] <- NA
    } else {
      cor_df$cor[cor_df$rpm_cutoff == i & cor_df$x == j] <- cor(x$bc2, x$bc4, use = "pairwise.complete.obs", method = "spearman")
    }
  }
}

ggplot(cor_df) +
  geom_point(aes(x = rpm_cutoff, y = as.numeric(cor))) +
  theme_bw() +
  ylim(0,1) +
  facet_wrap(~x)

## Compute the correlation between two technical replicates for each pDNA cutoff, for all reporters together
cor_df <- data.frame("rpm_cutoff"  = seq(0,100,1), "cor" = "", stringsAsFactors=FALSE)

for (i in unique(cor_df$rpm_cutoff)) {
    x <- bc_df_rep[bc_df_rep$pDNA_counts_rpm > i,]
    if (nrow(x) == 0) {
      cor_df$cor[cor_df$rpm_cutoff == i] <- NA
    } else {
      cor_df$cor[cor_df$rpm_cutoff == i] <- cor(x$bc2, x$bc4, "pairwise.complete.obs", method = "spearman")
    }
}

ggplot(cor_df) +
  geom_point(aes(x = rpm_cutoff, y = as.numeric(cor))) +
  theme_bw() +
  ylim(0,1) 


## Set a pDNA cutoff based on above plots
bc_df_cDNA_filt$activity[bc_df_cDNA_filt$pDNA_counts_rpm <= 10] <- NA
bc_df_rep <- bc_df_rep[bc_df_rep$pDNA_counts_rpm >= 10,]


# Correlation matrix plot
n <- sample(1:nrow(bc_df_rep), 5000)
boundaries <- seq(from = 0.8, by = 0.05, length.out = 4)
plt <- ggpairs(bc_df_rep %>% dplyr::select(bc1, bc2, bc3, bc4, bc5),
               upper = list(continuous = corColor),
               lower = list(continuous = function(data, mapping, ...) {
                   ggally_points(data = data[n, ], mapping = mapping, alpha = 0.1, size = 0.5) +
                   geom_abline(slope = 1, lty = "dashed", col = "red") +
                   theme_bw()}),
               diag = list(continuous = function(data, mapping, ...) {
                   ggally_densityDiag(data = data, mapping = mapping, alpha = 0.3, fill = "red") +
                   theme_bw()})) +
  ggtitle("Correlation Between Technial Replicates") +
  theme(text = element_text(size = 20)) +
  xlab("Reporter activity") +
  ylab("Reporter activity") + 
  theme_light()

print(plt)
```




```{r data export, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
# Polish export dataframe
bc_df_cDNA_filt <- bc_df_cDNA_filt %>% 
  mutate(log_activity = log2(activity),
         log_reporter_activity = log2(reporter_activity))


# Export bc_df for cDNA analysis
filename <- SetFileName("_reporter_activity_filt", "mt")
setwd("/DATA/usr/m.trauernicht/projects/SuRE_deep_scan_trp53_gr/data/gcf6210/results/")
write.csv(bc_df_cDNA_filt, file = paste(filename,".csv", sep = ""), row.names = F)
```

## Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

