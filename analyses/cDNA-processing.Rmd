---
title: "TP53 reporter library scan - detailed analysis"
author: 
  - name: "Max Trauernicht"
    email: "m.trauernicht@nki.nl"
    affiliation: "Netherlands Cancer Institute - van Steensel lab"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
---

---


### Introduction
~6,000 barcoded TP53 reporters were probed in MCF7 TP53WT/KO cells and stimulated with Nutlin-3a. I previously processed the raw sequencing data, quantified the pDNA data and normalized the cDNA data. In this script, a detailed dissection of the reporter activities will be carried out to understand how TP53 drives transcription and to identify the most sensitive TP53 reporters.


---

## Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
    $(document).ready(function() {
      $items = $('div#TOC li');
      $items.each(function(idx) {
        num_ul = $(this).parentsUntil('#TOC').length;
        $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
      });

    });
</script>

```{css, echo = FALSE}
div.sourceCode {
  overflow-x: hidden;
}
```

### Libraries 

```{r setup, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(RColorBrewer)
library(ggplot2)
library(dplyr)
library(maditr)
library(tibble)
library(pheatmap)
library(ggpubr)
library(ggbeeswarm)
library(ggforce)
library(viridis)
library(plyr)
library(cowplot)
library(gridExtra)
library(GGally)
library(readr)
library(stringr)
library(tidyr)
library(ROCR)
library(plotly)
library(randomForest)
library(glmnet)
library(glmnetUtils)
library(jtools)
library(ggrastr)
```

---

### Functions

```{r out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}


cbind.fill <- function(...){
    nm <- list(...) 
    nm <- lapply(nm, as.matrix)
    n <- max(sapply(nm, nrow)) 
    do.call(cbind, lapply(nm, function (x) 
        rbind(x, matrix(, n-nrow(x), ncol(x))))) 
}

# Function to substring the right part of the motif
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}


# Function to load PWM matrix
get_pwm_feature_matrix <- function(motif_meta_fn, fimo_fn, db = 2) {

  # validate args
  valid_dbs <- 1:2
  if(!db %in% valid_dbs)
    stop('Invalid db (database version). Please use db=1 (maintained for backward compatibility only) or db=2')

  # db=1 is maintained for backward compatibility only
  if(db == 1) {

    # read in motif metadata
    motif_meta    <- read.csv(motif_meta_fn)

    # check whether motif metadata contain essential annotations
    if(!all(c('PWM.ID', 'Cognate.TF') %in% colnames(motif_meta))) {
      message('The motif metadata file does not contain the essential columns PWM.ID and Cognate.TF')
    }

    motif_minimal <- motif_meta[, c('PWM.ID', 'Cognate.TF')]

    # load fimo output --> extract motif id, sequence id and p-value
    df <- read.table(fimo_fn)
    df <- df[, c(1, 2, 7)]

    colnames(df) <- c('PWM.ID', 'seqid', 'pval')

    # add TF id
    df <- merge(df, motif_minimal, by = 'PWM.ID')

    # group motif hits by sequence id
    l <- split(df, df[['seqid']])

    # multiple PWM and multiple hits possible. Reduce hits to one per TF, keeping best p-val only
    l <- lapply(l, function(x) {
      x_by_tf <- split(x, x[['Cognate.TF']], drop = TRUE)
      x_by_tf <- lapply(x_by_tf, function(y) y[which.min(y$pval), ])
      do.call('rbind', x_by_tf)
    })

    # initialize feature matrix
    n_tf          <- motif_minimal[['Cognate.TF']] %>%
      unique %>%
      length
    n_seq         <- length(l)
    pwm           <- matrix(1, nrow = n_seq, ncol = n_tf)
    colnames(pwm) <- (motif_minimal[['Cognate.TF']] %>% unique)

    # replace :: from names of composite motifs
    colnames(pwm) <- str_replace_all(colnames(pwm), '::', '_')

    # fill in feature matrix
    for(i in 1 : n_seq) {
      pwm[i, l[[i]][['Cognate.TF']]] <- l[[i]]$pval
    }

    # -log10 transform
    pwm           <- -1 * log10(pwm)

    # coerce to tib and return
    tib_fimo <- as_data_frame(pwm) %>%
      mutate(id = names(l))
      dplyr::select(id, everything())

  }

  # db = 2 (default)
  else {

    # load metadata
    tib_meta    <- read_csv(motif_meta_fn) %>%
      # extract tf symbol from motif id (Cognate_TF unsafe, it can be empty) and replace :: occurrences
      mutate(tf_symbol = str_remove(ID, '_[0-9]*'),
             tf_symbol = str_replace(tf_symbol, '::', '_')) %>%
      dplyr::select(motif_id = `PWM ID`, tf_symbol)

    # load fimo results
    tib_fimo <- read_tsv(fimo_fn) %>%
      # extract motif id, sequence id and p-value
      dplyr::select(motif_id, sequence_name, pval = `p-value`)

    # add tf symbol to fimo results
    tib_fimo <- tib_fimo %>%
      left_join(tib_meta, by = 'motif_id') %>%
      # remove hits with missing motif id (composite pwms)
      filter(!is.na(tf_symbol))

    # select best hit for each motif and sequence
    tib_fimo <- tib_fimo %>%
      dplyr::group_by(sequence_name, tf_symbol) %>%
      dplyr::slice(which.min(pval)) %>%
      ungroup()

    # spread into feature matrix
    tib_fimo <- tib_fimo %>%
      mutate(pval = -1 * log10(pval)) %>%
      dplyr::select(-motif_id) %>%
      spread(key = tf_symbol, value = pval, fill = 0, drop = TRUE) %>%
      # perform cosmetics on the id
      mutate(id = sequence_name) %>%
      dplyr::select(-c(sequence_name)) %>%
      dplyr::select(id, everything())

  }

  return(tib_fimo)

}

# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {

  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y, "pairwise.complete.obs")
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)

  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }

  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())

  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]

  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }

  p <- p +
    theme(panel.background = element_rect(fill = corCol))

  return(p)
}


# Custom ggplot2 themes
theme_classic_lines <- function() {
  theme_pubr(border = T,  legend = "top") +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
    
}

theme_classic_lines_45 <- function() {
  theme_pubr(border = T,  legend = "top", x.text.angle = 45) +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
}

theme_classic_lines_90 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 90) +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
}

theme_set(theme_classic_lines())

ggplot_cust <- function(...) ggplot2::ggplot(...) + 
  scale_color_manual(values = colors_diverse) + 
  scale_fill_manual(values = colors_diverse)

## save favorite colors
colors_diverse <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51")
colors_diverse_2 <- c("#CB997E", "#DDBEA9", "#FFE8D6", "#B7B7A4", "#A5A58D", "#6B705C")
colors_continous <- c("MCF7_KO" = "#DFE4DC", "MCF7_WT_DMSO" = "#CAD2C5", "MCF7_WT_Nutlin" = "#84A98C", "#52796F", "#354F52", "#2F3E46")
colors_continous_2 <- c("#F8F9FA", "#E9ECEF", "#DEE2E6", "#CED4DA", "#ADB5BD", "#6C757D", "#495057", "#343A40", "#212529")
reds <- c("#DD6B48", "#E38569", "#E7A08A", "#EDBBAB", "#EFC9BC")
colors_promoter <- c("#F6D289", "#ECD9B1", "#FBEDD0")
```

---

### Load data

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
# Import processed bc counts from the preprocessing step
cDNA_df <- read.csv("/DATA/usr/m.trauernicht/projects/P53_reporter_scan/data/gcf6502/results/mt20230216_reporter_activity_filt.csv", header = T)
cDNA_df$activity[is.na(cDNA_df$activity)] <- 0

# Recalculate mean activities
cDNA_df <- cDNA_df %>%
  mutate(reporter_activity = ave(reporter_activity, reporter_id, sample_id, FUN = function(x) mean(x)),
         log_reporter_activity = log2(reporter_activity))

# Change names
cDNA_df$tf <- as.character(cDNA_df$tf)
cDNA_df$condition[cDNA_df$condition == "MCF7"] <- "MCF7_WT_DMSO"
cDNA_df$condition[cDNA_df$condition == "MCF7_Nutlin"] <- "MCF7_WT_Nutlin"

# The activities are unnormalized at the moment - check if the conditions are scaled correctly
ggplot_cust(cDNA_df %>% 
         filter(neg_ctrls == "Yes", str_detect(tf, "53"), str_detect(condition, "MCF")) %>% 
         dplyr::select(tf, condition, reporter_activity, reporter_id, gcf, promoter) %>% 
         unique(), 
       aes(x = condition, y = reporter_activity, color = tf)) + 
  geom_quasirandom(dodge.width = 0.75) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_grid(promoter~gcf)

# Now I want to compute the enrichment over the inactive ones to center the data around 1 (1 = inactive)
cDNA_df_neg <- cDNA_df %>%
  dplyr::select(tf, sample_id, reporter_activity, reporter_id, neg_ctrls, promoter) %>%
  mutate(tf = gsub("_.*", "", tf)) %>%
  filter(neg_ctrls == "Yes") %>%
  mutate(tf = gsub("(.*random[1-3]{1})_.*", "\\1", reporter_id)) %>%
  filter(tf %in% c("P53_random1", "P53_random2")) %>%
  unique() %>%
  mutate(reporter_activity = ave(reporter_activity, sample_id, promoter, FUN = mean)) %>%
  dplyr::select(-reporter_id) %>%
  unique() %>%
  dplyr::select("background_activity" = reporter_activity, sample_id, promoter) %>%
  unique()

cDNA_df <- cDNA_df %>%
  mutate(tf = gsub("_.*", "", tf))
cDNA_df <- merge(cDNA_df, cDNA_df_neg)
cDNA_df <- cDNA_df %>%
  mutate(reporter_activity_norm = reporter_activity / background_activity,
         activity_norm = activity / background_activity)

# Compute means per sample and condition
cDNA_df$reporter_activity_condition <- ave(cDNA_df$reporter_activity_norm, cDNA_df$condition, cDNA_df$reporter_id, FUN = function(x) mean(x))
cDNA_df$reporter_activity_sample <- ave(cDNA_df$reporter_activity_norm, cDNA_df$sample_id, cDNA_df$reporter_id, FUN = function(x) mean(x))

# Additional normalization - this is necessary to correct for the different levels of TP53 in the MCF7-P53-WT and P53-KO cells
cDNA_df_neg2 <- cDNA_df %>%
  dplyr::select(tf, condition, reporter_activity_condition, reporter_id, neg_ctrls) %>%
  mutate(tf = gsub("_.*", "", tf)) %>%
  filter(neg_ctrls == "Yes") %>%
  mutate(tf = gsub("(.*random[1-3]{1})_.*", "\\1", reporter_id)) %>%
  filter(tf %in% c("GR_random1", "GR_random2")) %>% ## These are control reporters with medium activity - we use them to normalize the activities
  unique() %>%
  mutate(reporter_activity_condition = ave(reporter_activity_condition, condition, FUN = mean)) %>%
  dplyr::select(-reporter_id) %>%
  unique() %>%
  dplyr::select("condition_activity" = reporter_activity_condition, condition) %>%
  unique()

cDNA_df <- merge(cDNA_df, cDNA_df_neg2, by = "condition", all = T)
cDNA_df <- cDNA_df %>%
  mutate(reporter_activity_norm = reporter_activity_norm / condition_activity,
         activity_norm = activity_norm / condition_activity)

# Compute means per sample
cDNA_df$reporter_activity_condition <- ave(cDNA_df$reporter_activity_norm, cDNA_df$condition, cDNA_df$reporter_id, FUN = function(x) mean(x))
cDNA_df$reporter_activity_sample <- ave(cDNA_df$reporter_activity_norm, cDNA_df$sample_id, cDNA_df$reporter_id, FUN = function(x) mean(x))

# Check again if the conditions are scaled correctly
ggplot_cust(cDNA_df %>%
         filter(tf == "GR", neg_ctrls == "Yes", str_detect(condition, "MCF")) %>%
         dplyr::select(tf, sample_id, reporter_activity_sample, reporter_id, gcf, promoter) %>%
         unique(),
       aes(x = sample_id, y = reporter_activity_sample, color = tf)) +
  geom_quasirandom(dodge.width = 0.75) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_wrap(~promoter)

ggplot_cust(cDNA_df %>% 
         filter(neg_ctrls == "Yes", str_detect(tf, "53"), str_detect(condition, "MCF")) %>% 
         dplyr::select(tf, condition, reporter_activity_sample, reporter_id, gcf, promoter) %>% 
         unique(), 
       aes(x = condition, y = reporter_activity_sample, color = tf)) + 
  geom_quasirandom(dodge.width = 0.75) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_grid(promoter~gcf)


## Looks better
```

---

## Figure 1: Characterize P53 activities per condition

Aim: I want to characterize the reporter activity distributions in the tested conditions. Does Nutlin boost P53 reporter activity and is P53 inactive in the KO cells?
```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 1F: Correlate the three replicates:
compare_df <- cDNA_df %>%
  mutate(id = paste(gcf, replicate, sep = "_")) %>%
  filter((tf == "P53" & neg_ctrls == "No") | (tf == "GR" & neg_ctrls == "Yes"), promoter != "random", motif_id != "4_4_4_4") %>%
  mutate(ctrl_reporter = ifelse(tf == "GR", "Yes", "No")) %>%
  dplyr::select(reporter_id, reporter_activity_sample, condition, id, neg_ctrls, ctrl_reporter) %>%
  unique() %>%
  mutate(reporter_id = paste(reporter_id, condition, sep = "_")) %>%
  pivot_wider(names_from = id, values_from = reporter_activity_sample) %>%
  column_to_rownames("reporter_id") %>%
  mutate(condition = factor(condition, levels = c("MCF7_WT_Nutlin", "MCF7_WT_DMSO", "MCF7_KO")))

p1 <- ggplot(compare_df %>%
               mutate(ctrl_reporter = factor(ctrl_reporter, levels = c("No", "Yes"))) %>%
               arrange(ctrl_reporter),
             aes(x = gcf6502_r1, y = gcf6502_r2)) +
  geom_abline(lty = 2)+
  geom_point_rast(alpha = 0.2, stroke = 0, raster.dpi=600, aes(color = ctrl_reporter)) +
  xlim(0,120) +
  ylim(0,120) +
  scale_color_manual(values = c("No" = "black", "Yes" = "red"))


p2 <- ggplot(compare_df %>%
               mutate(ctrl_reporter = factor(ctrl_reporter, levels = c("No", "Yes"))) %>%
               arrange(ctrl_reporter),
             aes(x = gcf6502_r1, y = gcf6881_r3)) +
  geom_abline(lty = 2)+
  geom_point_rast(alpha = 0.2, stroke = 0, raster.dpi=600, aes(color = ctrl_reporter)) +
  xlim(0,120) +
  ylim(0,120) +
  scale_color_manual(values = c("No" = "black", "Yes" = "red"))



p3 <-ggplot(compare_df %>%
               mutate(ctrl_reporter = factor(ctrl_reporter, levels = c("No", "Yes"))) %>%
               arrange(ctrl_reporter),
             aes(x = gcf6502_r2, y = gcf6881_r3)) +
  geom_abline(lty = 2)+
  geom_point_rast(alpha = 0.2, stroke = 0, raster.dpi=600, aes(color = ctrl_reporter)) +
  xlim(0,120) +
  ylim(0,120) +
  scale_color_manual(values = c("No" = "black", "Yes" = "red")) 
  


plot_grid(p1, p2, p3, nrow = 1)


cor(compare_df$gcf6502_r1, compare_df$gcf6502_r2, method = "pearson", use = "pairwise.complete.obs")
cor(compare_df$gcf6502_r1, compare_df$gcf6881_r3, method = "pearson", use = "pairwise.complete.obs")
cor(compare_df$gcf6881_r3, compare_df$gcf6502_r2, method = "pearson", use = "pairwise.complete.obs")



## Figure 1G: Reporter activity per condition, compared to negative and positive controls
data <- cDNA_df %>%
  filter((tf == "P53" & neg_ctrls == "No") | (tf == "GR" & neg_ctrls == "Yes"), promoter != "random", motif_id != "4_4_4_4") %>%
  mutate(ctrl_reporter = ifelse(tf == "GR", "Yes", "No")) %>%
  dplyr::select(reporter_activity_condition, positive_ctrl, promoter, condition, neg_ctrls, affinity_id, tf, condition, reporter_id, positive_ctrl, ctrl_reporter) %>%
  ungroup() %>%
  unique()

ggplot(data %>%
         filter(neg_ctrls == "No"), 
       aes(y = reporter_activity_condition, x = condition, group = neg_ctrls)) + 
  geom_quasirandom_rast(aes(color = condition), dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600, bandwidth = 0.4, width = 0.35, method = "smiley") + 
  stat_summary(fun = median, fun.min = median, fun.max = median, geom = "crossbar", color = "black", width = 0.25, lwd = 0.4) +
  xlab("condition") + 
  scale_color_manual(values = colors_continous) +
  ylab("reporter activity")



ggplot(data %>%
         filter(neg_ctrls == "No"), 
       aes(x = reporter_activity_condition, fill = condition)) + 
  geom_density() +
  scale_fill_manual(values = colors_continous) +
  xlab("reporter activity")
```

Conclusion: 1F: Replicates do correlate well. 1G: Negative controls are inactive compared to P53 reporters. P53 reporters become more active in WT cells and even more active upon Nutlin stimulation. 


---

## Figure 2: Effect of affinity and binding sites + binding site positioning

Aim: How does the binding site affinity, copy number, and their respective positioning affect reporter activity?

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 2A: activity per affinity
colors_new <- c("1_high_only" = "#C55330", "3_med_only" = "#DD6B48", "5_low_only" = "#E7A08A", "7_very-low_only" = "#F1C8BB", "9_null_only" = "#F7E4DE", colors_continous[c(1,2,3)])
ggplot(cDNA_df %>%
           filter(neg_ctrls == "No", promoter == "mCMV", positive_ctrl == "No", spacing == 7, tf == "P53",position == 0,
                  #str_detect(condition, "MCF7_WT"),
                  str_detect(affinity_id, "[1,3,5,7,9]_"), str_detect(affinity_id, "11_high_mid", negate = T)) %>%
           dplyr::select(tf, reporter_activity_condition, background, reporter_id, condition, affinity_id) %>%
         mutate(affinity_id = factor(affinity_id, levels = c("9_null_only", "7_very-low_only", "5_low_only", "3_med_only", "1_high_only"))) %>%
           unique(), 
       aes(x = condition, y = reporter_activity_condition)) +    
  geom_quasirandom(dodge.width = .75, aes(color = affinity_id, group = affinity_id)) +
  geom_boxplot(position = position_dodge(.75), aes(color = affinity_id), alpha = 0.7, outlier.shape = NA) +
  xlab("") +
  ylab("Reporter activity") +
  scale_fill_manual(values = colors_new) +
  scale_color_manual(values = colors_new) +
  stat_compare_means(method = "t.test") 

ggplot(cDNA_df %>%
           filter(neg_ctrls == "No", promoter == "mCMV", positive_ctrl == "No", spacing == 7, tf == "P53",
                  str_detect(affinity_id, "[1,3,5,7,9]_"), str_detect(affinity_id, "11_high_mid", negate = T)) %>%
         dplyr::select(tf, reporter_activity_condition, background, reporter_id, condition, affinity_id) %>%
         mutate(affinity_id = factor(affinity_id, levels = c("9_null_only", "7_very-low_only", "5_low_only", "3_med_only", "1_high_only"))) %>%
         unique() %>%
         mutate(reporter_activity_condition = ave(reporter_activity_condition, affinity_id, condition, background, FUN = function(x) mean(x))) %>%
         mutate(reporter_activity_condition_mean = ave(reporter_activity_condition, affinity_id, condition, FUN = function(x) mean(x))) %>%
         mutate(reporter_activity_condition_sd = ave(reporter_activity_condition, affinity_id, condition, FUN = function(x) sd(x))) %>%
         dplyr::select(-reporter_activity_condition, -reporter_id, -background) %>%
         distinct(), 
       aes(x = condition, y = reporter_activity_condition_mean, fill = affinity_id, group = affinity_id)) +    
  geom_errorbar(aes(ymin=reporter_activity_condition_mean-reporter_activity_condition_sd, ymax=reporter_activity_condition_mean+reporter_activity_condition_sd), width=.2, position=position_dodge(.75)) +
  geom_bar(stat = "identity", position = position_dodge(0.75), width = 0.75, color = "white")+
  xlab("") +
  ylab("Reporter activity") +
  scale_fill_manual(values = colors_new) +
  scale_color_manual(values = colors_new)



## Figure 2B: Effect of adding binding sites
ggplot(cDNA_df %>%
         filter(neg_ctrls == "No", positive_ctrl == "No",promoter == "mCMV", 
                str_detect(condition, "MCF7_WT"), str_detect(motif_id, "4_4_4_4|4_4_4_3|4_4_3_3|4_3_3_3|3_3_3_3"), 
                tf == "P53", spacing == 7) %>%
         distinct(reporter_activity_condition, n_sites, condition, background) %>% 
         mutate(reporter_activity_condition = ave(reporter_activity_condition, n_sites, condition, background, FUN = function(x) mean(x))) %>%
         mutate(reporter_activity_condition_mean = ave(reporter_activity_condition, n_sites, condition, FUN = function(x) mean(x))) %>%
         mutate(reporter_activity_condition_sd = ave(reporter_activity_condition, n_sites, condition, FUN = function(x) sd(x))) %>%
         dplyr::select(-reporter_activity_condition) %>%
         distinct(), 
       aes(x = n_sites, y = reporter_activity_condition_mean, fill = condition)) +
  geom_errorbar(aes(ymin=reporter_activity_condition_mean-reporter_activity_condition_sd, ymax=reporter_activity_condition_mean+reporter_activity_condition_sd), width=.2, position=position_dodge(.9)) +
  geom_bar(stat = "identity", position = position_dodge(0.8), width = 0.9, color = "white")+
  ggtitle("reporter activity vs number of binding sites")+
  xlab("number of low-affinity binding sites")+
  ylab("reporter activity (a.u.)")+
  scale_fill_manual(values = colors_continous)



## Figure 2C: activity for different number of binding sites - the positioning effect
data <- cDNA_df %>%
         filter(neg_ctrls == "No", positive_ctrl == "No", promoter == "mCMV", 
                str_detect(condition, "MCF7_WT"), str_detect(condition, "PFT", negate = T), str_detect(affinity_id, "[7-9]_"), 
                tf == "P53", spacing == 7) %>%
         dplyr::select(tf, reporter_activity_condition, n_sites, motif_id, condition, affinity_id, gcf) %>% 
         unique() %>%
         mutate(reporter_activity_condition = ave(reporter_activity_condition, motif_id, condition, FUN = function(x) mean(x))) %>%
         unique()

ggplot(data, 
       aes(x = n_sites, y = reporter_activity_condition, color = condition)) +
  geom_point(position = position_dodge(0.75), size = 3, stroke = 0)+
  geom_label(data = data %>% 
               filter(n_sites != 0, n_sites != 4) %>%
               dplyr::select(reporter_activity_condition, motif_id, condition, n_sites) %>%
               arrange(desc(reporter_activity_condition)) %>% 
               dplyr::group_by(n_sites) %>% 
               slice_head(n=3), 
             aes(label = motif_id), 
             nudge_x = -.3) +
  ggtitle("reporter activity vs number of binding sites")+
  xlab("number of low-affinity binding sites")+
  ylab("reporter activity (a.u.)")+
  scale_color_manual(values = colors_continous)
```

Conclusion: BS006 is the most responsive to Nutlin-3a. Addition of binding sites is super-additive. Positioning of binding sites matters - putting them directly next to each other is inhibitory, and putting them close to the TSS leads to higher activity.

---

Figure 3: The effect of the spacer length.

Aim: Show how the spacer length between adjacent binding sites affects reporter activity. 

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 3A: activity per spacing at different affinities
ggplot(cDNA_df %>%
         filter(neg_ctrls == "No", promoter == "mCMV", positive_ctrl == "No",
                str_detect(affinity_id, "[1,3,5,7]{1}_"), str_detect(affinity_id, "11_high_mid", negate = T),
                position == 0, tf == "P53") %>%
         distinct(tf, reporter_activity_condition, reporter_id, spacing, condition, affinity_id) %>% 
         mutate(reporter_activity_spacing = ave(reporter_activity_condition, affinity_id, condition, spacing, FUN = mean)) %>%
         unique(), 
       aes(x = spacing, y = reporter_activity_spacing, color = condition, fill = condition)) +
  geom_point() +
  geom_smooth()+
  #theme_pubr(border = T) +
  ggtitle("reporter activity per spacing")+
  xlab("spacing length between motifs (bp)")+
  ylab("reporter activity (a.u.)")+
  scale_color_manual(values = colors_continous)+
  scale_fill_manual(values = colors_continous)+
  facet_wrap(~affinity_id, nrow = 2) +
  scale_x_continuous(breaks = seq(0,10,1))

## Figure 3B: activity as a function of spacer length per minimal promoter and spacer sequence
ggplot(cDNA_df %>%
         filter(neg_ctrls == "No", promoter != "random", positive_ctrl == "No",
                str_detect(affinity_id, "[5]{1}_"), str_detect(affinity_id, "11_high_mid", negate = T),
                position == 0, tf == "P53") %>%
         dplyr::select(tf, reporter_activity_condition, reporter_id, spacing, condition, affinity_id, promoter, background) %>% 
         unique() %>%
         mutate(reporter_activity_spacing = ave(reporter_activity_condition, affinity_id, promoter, background, condition, spacing, FUN = function(x) mean(x))) %>%
         mutate(promoter = factor(promoter, levels = c("minP", "mCMV"))) %>%
         unique(), 
       aes(x = spacing, y = reporter_activity_spacing, color = condition, fill = condition)) +
  geom_point() +
  geom_smooth()+
  #theme_pubr(border = T) +
  ggtitle("reporter activity per spacing")+
  xlab("spacing length between motifs (bp)")+
  ylab("reporter activity (a.u.)")+
  scale_color_manual(values = colors_continous)+
  scale_fill_manual(values = colors_continous)+
  facet_grid(background~promoter) +
  scale_x_continuous(breaks = seq(0,10,1))
```

Conclusion: Spacer length influences activity periodically. Adjacent binding sites need to be 180 degrees tilted with respect to each other to achieve optimal activation.

---

## Figure 4: The effect of the minimal promoter and the spacer sequence. 

Aim: Show how the P53 reporters interact with the two minimal promoters and the three spacer sequences.

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 4A: minimal promoters background activity
data <- cDNA_df %>%
  filter(neg_ctrls == "Yes", positive_ctrl == "No",tf == "P53") %>%
  dplyr::select(tf, reporter_activity, n_sites, motif_id, condition, reporter_id, background, promoter) %>% 
  mutate(reporter_activity_condition = ave(reporter_activity, reporter_id, condition, FUN = mean)) %>%
  dplyr::select(-reporter_activity) %>%
  unique() %>%
  na.omit()

ggplot(data, aes(x = promoter, y = reporter_activity_condition)) +
  geom_quasirandom_rast(stroke = 0, alpha = 1, size = 1, raster.dpi = 600) + 
  geom_boxplot(aes(fill = promoter), alpha = .8, outlier.shape = NA) +
  scale_fill_manual(values = c("#F2BE54", "#FBEDD0", "white"))+
  stat_compare_means(method = "wilcox.test")

## Figure 4B: reporter activity distribution - compare promoters
ggplot(cDNA_df %>%
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")) %>%
         filter(neg_ctrls == "No",
                motif_id != "4_4_4_4", tf == "P53") %>%
         dplyr::select(condition, reporter_activity_condition, reporter_id, positive_ctrl, promoter, tf) %>%
         unique(),
       aes(x = condition, y = reporter_activity_condition, fill = promoter)) + 
  geom_quasirandom_rast(dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600, bandwidth = 0.4, width = 0.1, method = "smiley") + 
  geom_boxplot(position = position_dodge(0.75), alpha = 0.8, outlier.shape = NA)+
  xlab("") + 
  ylab("reporter activity (a.u.)") +
  labs(title = "reporter activity distribution per minimal promoter") +
  scale_fill_manual(values = colors_promoter)+ 
  stat_compare_means(method = "wilcox.test") 

## Figure 4C: reporter activity distribution - only random promoters
ggplot(cDNA_df %>%
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")) %>%
         filter(neg_ctrls == "No", promoter == "random",
                motif_id != "4_4_4_4", tf == "P53") %>%
         dplyr::select(condition, reporter_activity_condition, reporter_id, positive_ctrl, promoter, tf) %>%
         unique(),
       aes(x = condition, y = reporter_activity_condition, fill = promoter)) + 
  geom_quasirandom_rast(dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600) + 
  geom_boxplot(position = position_dodge(0.75), alpha = 0.8, outlier.shape = NA)+
  xlab("") + 
  ylab("reporter activity (a.u.)") +
  #labs(title = "reporter activity distribution per minimal promoter") +
  scale_fill_manual(values = colors_promoter)+ 
  stat_compare_means(method = "wilcox.test") 

## Figure 4D: activities of random promoter reporters
ggplot(cDNA_df %>%
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")) %>%
         filter(neg_ctrls == "No", promoter == "random",
                motif_id != "4_4_4_4", tf == "P53") %>%
         dplyr::select(condition, reporter_activity_condition, reporter_id, positive_ctrl, promoter, tf, n_sites) %>%
         unique() %>%
         spread(key = "condition", value = "reporter_activity_condition"),
       aes(x = MCF7_WT_DMSO, y = MCF7_WT_Nutlin, color = as.factor(n_sites))) + 
  geom_point() +
  geom_abline(lty = 2) +
  xlab("TP53-WT") + 
  ylab("TP53-WT + Nutlin-3a") +
  ylim(0,12) +
  xlim(0,12) +
  scale_color_manual(values = c(`1` = "grey90", `2` = "grey90", `3` = "grey90", `4` = "grey20"))

## Figure 4E: impact of background sequence
ggplot(cDNA_df %>% 
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin"))%>%
         filter(neg_ctrls == "No", positive_ctrl == "No", promoter != "random", 
                str_detect(affinity_id, "[9]_", negate = T), 
                tf == "P53") %>%
         dplyr::select(tf, reporter_activity_condition, background, reporter_id, condition, affinity_id, promoter) %>% 
         unique(), aes(x = condition, y = reporter_activity_condition, color = factor(background))) +
  geom_quasirandom_rast(dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600, bandwidth = 0.4, width = 0.1) + 
  geom_boxplot(position = position_dodge(.75), alpha = .7, outlier.shape = NA)+
  scale_color_manual(values = c("#000000","#666666", "#999999"))+
  labs(title = "reporter activity per background")+
  xlab("background sequence")+
  ylab("reporter activity")+
  facet_wrap(~promoter)+ 
  stat_compare_means(method = "wilcox.test") 

## Figure 4F: correlate minP and mCMV reporter activities
data <- cDNA_df %>%
  filter(neg_ctrls == "No", positive_ctrl == "No", promoter != "random", motif_id != "4_4_4_4", tf == "P53") %>%
  dplyr::select(tf, reporter_activity_condition, n_sites, motif_id, condition, reporter_id_2, background, promoter) %>% 
  unique() %>%
  spread(promoter, reporter_activity_condition) %>% 
  na.omit()

ggplot(data %>% 
           filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")), aes(x = minP, y = mCMV)) +
    geom_abline(lty = 1) + 
    geom_abline(slope = mean(data$mCMV)/mean(data$minP), linetype = 2) +
    geom_smooth(method = "lm", aes(color = factor(background), fill = factor(background)), alpha = 0.2, lty = 2) +
    geom_point(size = 1.5, aes(color = factor(background)), stroke = 0, alpha = .3) +
    scale_color_manual(values = c("#000000","#666666", "#999999")) +
    scale_fill_manual(values = c("#000000","#666666", "#999999")) +
    facet_wrap(~background) + 
    ylim(0,120) + 
    xlim(0,120) 


# Figure 4G: reporters with 0bp spacing
data <- cDNA_df %>%
  filter(neg_ctrls == "No", positive_ctrl == "No", promoter != "random", motif_id != "4_4_4_4", spacing == 0, tf == "P53") %>%
  dplyr::select(tf, reporter_activity_condition, n_sites, motif_id, condition, reporter_id_2, background, promoter) %>% 
  unique()%>%
  spread(promoter, reporter_activity_condition) %>% 
  na.omit()

ggplot(data %>% 
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")), 
       aes(x = minP, y = mCMV)) +
    geom_abline(lty = 1) + 
    geom_abline(slope = mean(data$mCMV)/mean(data$minP), linetype = 2) +
    geom_smooth(method = "lm", aes(color = factor(background), fill = factor(background)), alpha = 0.2, lty = 2) +
    geom_point(size = 1.5, aes(color = factor(background)), stroke = 0) +
  scale_color_manual(values = c("#000000","#666666", "#999999")) +
  scale_fill_manual(values = c("#000000","#666666", "#999999")) +
  facet_wrap(~background) + 
  ylim(0,80) + 
  xlim(0,80) 
```

Conclusion: Promoter and spacer sequence influence activity linearly.

---

## Figure 5 & 6: Linear model + Selection of best reporters

Aim: Can we explain now every observation using a linear model?
```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 6A: Show that some reporters are superior to commercial reporters
compare_df <- cDNA_df %>%
  filter(neg_ctrls == "No",tf == "P53",
         position %in% c(0, 60, 70), promoter != "random",
         !affinity_id %in% c("9_null_only")) %>%
  dplyr::select(reporter_id, reporter_activity_condition, condition, neg_ctrls, tf, promoter, positive_ctrl, motif_id, SumAffinity, spacing) %>%
  unique() %>%
  pivot_wider(names_from = condition, values_from = reporter_activity_condition) %>%
  mutate(dif = MCF7_WT_Nutlin / MCF7_WT_DMSO) %>%
  mutate(dif_KO_Nutlin = MCF7_WT_Nutlin / MCF7_KO) %>%
  mutate(dif_KO_DMSO = MCF7_WT_DMSO / MCF7_KO) %>%
  na.omit()

library(scales)
ggplot(compare_df %>%
         filter(neg_ctrls == "No"
                #, 
                #str_detect(motif_id,"2", negate = T)
                ),
       aes(x = MCF7_WT_DMSO, y = MCF7_WT_Nutlin)) +
  geom_abline(lty = 2) +
  geom_point(aes(color = dif), size = 1.5) +
  scale_color_manual(values = c("black", "red"))  +
  # geom_label(data = compare_df %>% 
  #              filter(neg_ctrls == "No", str_detect(motif_id,"2", negate = T)) %>%
  #              filter(dif > 70 | MCF7_WT_Nutlin > 85), 
  #            aes(label = motif_id), 
  #            nudge_y = +6,
  #            color = "black") +
  ylab("Reporter activity (P53-WT + Nutlin-3a)") +
  xlab("Reporter activity (P53-WT)") +
  scale_color_gradient2(low = "#DBE6DD", high = colors_continous[3],  limits = c(0,5), oob = squish)

## Figure 6B: Line-plot comparing sensitivities of my reporters to positive controls
top_reporters <- compare_df %>%
         filter(neg_ctrls == "No", str_detect(motif_id,"2", negate = T)) %>%
  distinct(MCF7_WT_Nutlin, reporter_id) %>%
  arrange(desc(MCF7_WT_Nutlin)) %>%
  top_n(6)

compare_df2 <- cDNA_df %>%
  filter(tf == "P53", motif_id != "4_4_4_4", promoter != "random") %>%
  filter(reporter_id %in% top_reporters$reporter_id | positive_ctrl == "Yes") %>%
  dplyr::select(reporter_id, reporter_activity_condition, condition, neg_ctrls, tf, promoter, positive_ctrl, motif_id, SumAffinity, spacing) %>%
  unique() 

ggplot(compare_df2,
       aes(x = condition, y = reporter_activity_condition, color = positive_ctrl, group = reporter_id)) +
  geom_point() +
  geom_line() +
  ylab("Reporter activity")+
  scale_color_manual(values = c("Yes" = "red", "No" = "grey60"))


## 5F-G: Linear model to fit most active reporters

## Subselect reporters
cDNA_df_p53 <- cDNA_df %>%
  filter(neg_ctrls == "No", positive_ctrl == "No",tf == "P53",
         position == 0, promoter != "random",
         affinity_id %in% c( "1_high_only", 
                            "3_med_only", 
                            "5_low_only", 
                            "7_very-low_only")) %>%
  dplyr::select(condition, reporter_activity_condition, promoter, background, 
                affinity_pos1, spacing, n_sites, motif_id, affinity_id, reporter_id) %>%
  mutate(background = as.factor(background),
         reporter_activity = ave(reporter_activity_condition, motif_id, condition, n_sites, spacing, promoter, background, FUN = function(x) mean(x))) %>%
  dplyr::select(-reporter_activity_condition) %>%
  unique() %>%
  mutate(n_sites = as.character(n_sites))%>%
  mutate(affinity_pos1 = ifelse(affinity_id == "8_very-low_null", "3", affinity_pos1)) %>%
  mutate(promoter = as.factor(promoter)) %>%
  distinct()


## Mutate spacing to helical turn
cDNA_df_p53 <- cDNA_df_p53 %>%
  mutate(spacing = spacing - 1) %>%
  mutate(spacing_rotation = (spacing) / 10.5) %>%
  mutate(spacing_degree = 2* pi * spacing_rotation) %>%
  mutate(spacing_degree = ifelse(is.infinite(spacing_degree), 0, spacing_degree)) %>%
  mutate(spacing_degree_transf = cos(spacing_degree)) %>%
  mutate(close = ifelse(spacing == 0, "yes", "no")) ## Punish reporters that are directly next to each other




# Rename 0,1,2,3,4 in null, very-weak, weak, medium, strong
replace <- data.frame("old" = c(0:4), "new" = c("BS100", "BS037", "BS014", "BS006", "BS000"), stringsAsFactors=FALSE)
for (i in unique(replace$old)) {
  cDNA_df_p53$affinity_pos1[cDNA_df_p53$affinity_pos1 == i] <- replace$new[replace$old == i]
}

cDNA_df_p53$promoter <- relevel(cDNA_df_p53$promoter, ref = "minP")

cDNA_df_p53_nutlin <- cDNA_df_p53 %>% filter(condition == "MCF7_WT_Nutlin")

cDNA_df_p53_nutlin$row <- rownames(cDNA_df_p53_nutlin)

## Fitting the model
x <- lm(log2(reporter_activity) ~  promoter*background + spacing_degree_transf + affinity_id, cDNA_df_p53_nutlin)

summ(x)
par(mfrow=c(2,2))
plot(x)

# Get predicted activities per reporter
y <- data.frame(x$fitted.values, stringsAsFactors=FALSE) %>% rownames_to_column()
names(y) <- c("row", "reporter_activity_predicted")
y$id <- 1:nrow(y)
prediction <- data.frame("id" = 1:(nrow(cDNA_df_p53_nutlin)), stringsAsFactors=FALSE)
prediction <- merge(prediction,y, all = T) %>% 
  dplyr::select(-id)
cDNA_df_p53_nutlin <- merge(cDNA_df_p53_nutlin, prediction)
  

# What are the individual weights?
weight <- data.frame(x$coefficients, stringsAsFactors=FALSE) %>% rownames_to_column() %>% na.omit()
names(weight) <- c("feature", "weight")
weight_intercepts <- data.frame("feature" = c("1_high_only", "promoterminP", "background1"), "weight" = c(0, 0, 0))
weight <- rbind(weight, weight_intercepts)
categorie <- c("promoter_background", "affinity_id")
weight$features <- gsub(paste(categorie, collapse="|"), "",weight$feature)
weight$cond <- gsub(paste(weight$features, collapse = "|"), "", weight$feature)
weight <- weight %>% filter(feature != "(Intercept)") %>% mutate(condition = "Nutlin")

cDNA_df_p53_dmso <- cDNA_df_p53 %>% filter(condition == "MCF7_WT_DMSO")

cDNA_df_p53_dmso$row <- rownames(cDNA_df_p53_dmso)


## Fitting the model
y <- lm(log2(reporter_activity) ~  promoter*background + spacing_degree_transf + affinity_id, cDNA_df_p53_dmso)

summ(y)
par(mfrow=c(2,2))
plot(y)

# Get predicted activities per reporter
y_dmso <- data.frame(y$fitted.values, stringsAsFactors=FALSE) %>% rownames_to_column()
names(y_dmso) <- c("row", "reporter_activity_predicted")
y_dmso$id <- 1:nrow(y_dmso)
prediction <- data.frame("id" = 1:(nrow(cDNA_df_p53_dmso)), stringsAsFactors=FALSE)
prediction <- merge(prediction,y_dmso, all = T) %>% 
  dplyr::select(-id)
cDNA_df_p53_dmso <- merge(cDNA_df_p53_dmso, prediction) 

cDNA_df_p53 <- rbind(cDNA_df_p53_dmso, cDNA_df_p53_nutlin)
  

# What are the individual weight_dmsos?
weight_dmso <- data.frame(y$coefficients, stringsAsFactors=FALSE) %>% rownames_to_column() %>% na.omit()
names(weight_dmso) <- c("feature", "weight")
weight_dmso <- rbind(weight_dmso, weight_intercepts)
categorie <- c("promoter_background", "affinity_id")
weight_dmso$features <- gsub(paste(categorie, collapse="|"), "",weight_dmso$feature)
weight_dmso$cond <- gsub(paste(weight_dmso$features, collapse = "|"), "", weight_dmso$feature)
weight_dmso <- weight_dmso %>% filter(feature != "(Intercept)") %>% mutate(condition = "DMSO")

weight <- rbind(weight_dmso, weight)

## Figure 5C: Correlation between predicted and measured activity
ggplot(cDNA_df_p53 #%>%
         #mutate(top_6 = ifelse(reporter_id %in% top_reporters$reporter_id, "top", "notop")) %>%
       ,
       aes(x = log2(reporter_activity), y = reporter_activity_predicted, color = affinity_pos1
           #, 
           #color = top_6
           )) +
  geom_abline(lty = 2) +
  geom_smooth(color = "black", method = "lm") +
  geom_point(size = 2) +
  scale_color_manual(values = c("BS100" = "#DC6641", "BS037" = "#E99D86", "BS014" = "#EDBBAB", "BS006" = "#F7E4DE")) +
  xlab("Measured reporter activity") +
  ylab("Predicted reporter activity") +
  theme(legend.position = "none") +
  facet_wrap(~condition)

level_order <- rev(c("spacing_degree_transf", "1_high_only", "3_med_only", "5_low_only", "7_very-low_only", 
                     "promoterminP", "promotermCMV", "background1", "background2", "background3", "promotermCMV:background2", "promotermCMV:background3"))

## Figure 5D: Weights of the fitted model
ggplot(weight, 
       aes(y = factor(features, level = level_order), x = weight)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.75, color = "black") + 
  ylab("weight - reporter activity") +
  xlab("") +
  #scale_fill_manual(values = colors_continous_2[c(1,3,5,6)]) +
  guides(fill = F)+
  theme_classic_lines_90() +
  facet_wrap(~condition)

```

Conlusion: Top reporters are better than commercial reporters. Linear model gives insights into which features are important to drive high expression.


# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

