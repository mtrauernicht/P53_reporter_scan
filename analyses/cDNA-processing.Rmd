---
title: "P53 library - activity computation - all data combined"
author:
- name: Max Trauernicht
  email: m.trauernicht@nki.nl
  affiliation: "Netherlands Cancer Institute - van Steensel lab"
date: "`r format(Sys.time(), "%d/%m/%Y")`"
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
---

---


### Introduction
~18,000 barcoded P53 reporters were probed in MCF7 P53WT/KO cells and stimulated with Nutlin-3a. I previously processed the raw sequencing data, quantified the pDNA data and normalized the cDNA data. In this script, a detailed dissection of the reporter activities will be carried out to understand how P53 drives transcription and to identify the most sensitive P53 reporters.


---

## Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
    $(document).ready(function() {
      $items = $('div#TOC li');
      $items.each(function(idx) {
        num_ul = $(this).parentsUntil('#TOC').length;
        $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
      });

    });
</script>

```{css, echo = FALSE}
div.sourceCode {
  overflow-x: hidden;
}
```

### Libraries 

```{r setup, out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(RColorBrewer)
library(ggplot2)
library(dplyr)
library(maditr)
library(tibble)
library(pheatmap)
library(ggpubr)
library(ggbeeswarm)
library(ggforce)
library(viridis)
library(plyr)
library(cowplot)
library(gridExtra)
library(GGally)
library(readr)
library(stringr)
library(tidyr)
library(ROCR)
library(plotly)
library(randomForest)
library(glmnet)
library(glmnetUtils)
library(jtools)
library(ggrastr)
```

---

### Functions

```{r out.width= "80%", fig.align= "center", echo=FALSE, warning= FALSE, message=FALSE}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}


cbind.fill <- function(...){
    nm <- list(...) 
    nm <- lapply(nm, as.matrix)
    n <- max(sapply(nm, nrow)) 
    do.call(cbind, lapply(nm, function (x) 
        rbind(x, matrix(, n-nrow(x), ncol(x))))) 
}

# Function to substring the right part of the motif
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}


# Function to load PWM matrix
get_pwm_feature_matrix <- function(motif_meta_fn, fimo_fn, db = 2) {

  # validate args
  valid_dbs <- 1:2
  if(!db %in% valid_dbs)
    stop('Invalid db (database version). Please use db=1 (maintained for backward compatibility only) or db=2')

  # db=1 is maintained for backward compatibility only
  if(db == 1) {

    # read in motif metadata
    motif_meta    <- read.csv(motif_meta_fn)

    # check whether motif metadata contain essential annotations
    if(!all(c('PWM.ID', 'Cognate.TF') %in% colnames(motif_meta))) {
      message('The motif metadata file does not contain the essential columns PWM.ID and Cognate.TF')
    }

    motif_minimal <- motif_meta[, c('PWM.ID', 'Cognate.TF')]

    # load fimo output --> extract motif id, sequence id and p-value
    df <- read.table(fimo_fn)
    df <- df[, c(1, 2, 7)]

    colnames(df) <- c('PWM.ID', 'seqid', 'pval')

    # add TF id
    df <- merge(df, motif_minimal, by = 'PWM.ID')

    # group motif hits by sequence id
    l <- split(df, df[['seqid']])

    # multiple PWM and multiple hits possible. Reduce hits to one per TF, keeping best p-val only
    l <- lapply(l, function(x) {
      x_by_tf <- split(x, x[['Cognate.TF']], drop = TRUE)
      x_by_tf <- lapply(x_by_tf, function(y) y[which.min(y$pval), ])
      do.call('rbind', x_by_tf)
    })

    # initialize feature matrix
    n_tf          <- motif_minimal[['Cognate.TF']] %>%
      unique %>%
      length
    n_seq         <- length(l)
    pwm           <- matrix(1, nrow = n_seq, ncol = n_tf)
    colnames(pwm) <- (motif_minimal[['Cognate.TF']] %>% unique)

    # replace :: from names of composite motifs
    colnames(pwm) <- str_replace_all(colnames(pwm), '::', '_')

    # fill in feature matrix
    for(i in 1 : n_seq) {
      pwm[i, l[[i]][['Cognate.TF']]] <- l[[i]]$pval
    }

    # -log10 transform
    pwm           <- -1 * log10(pwm)

    # coerce to tib and return
    tib_fimo <- as_data_frame(pwm) %>%
      mutate(id = names(l))
      dplyr::select(id, everything())

  }

  # db = 2 (default)
  else {

    # load metadata
    tib_meta    <- read_csv(motif_meta_fn) %>%
      # extract tf symbol from motif id (Cognate_TF unsafe, it can be empty) and replace :: occurrences
      mutate(tf_symbol = str_remove(ID, '_[0-9]*'),
             tf_symbol = str_replace(tf_symbol, '::', '_')) %>%
      dplyr::select(motif_id = `PWM ID`, tf_symbol)

    # load fimo results
    tib_fimo <- read_tsv(fimo_fn) %>%
      # extract motif id, sequence id and p-value
      dplyr::select(motif_id, sequence_name, pval = `p-value`)

    # add tf symbol to fimo results
    tib_fimo <- tib_fimo %>%
      left_join(tib_meta, by = 'motif_id') %>%
      # remove hits with missing motif id (composite pwms)
      filter(!is.na(tf_symbol))

    # select best hit for each motif and sequence
    tib_fimo <- tib_fimo %>%
      group_by(sequence_name, tf_symbol) %>%
      dplyr::slice(which.min(pval)) %>%
      ungroup()

    # spread into feature matrix
    tib_fimo <- tib_fimo %>%
      mutate(pval = -1 * log10(pval)) %>%
      dplyr::select(-motif_id) %>%
      spread(key = tf_symbol, value = pval, fill = 0, drop = TRUE) %>%
      # perform cosmetics on the id
      mutate(id = sequence_name) %>%
      dplyr::select(-c(sequence_name)) %>%
      dplyr::select(id, everything())

  }

  return(tib_fimo)

}

# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {

  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y, "pairwise.complete.obs")
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)

  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }

  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())

  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]

  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }

  p <- p +
    theme(panel.background = element_rect(fill = corCol))

  return(p)
}


# Custom ggplot2 themes
theme_classic_lines <- function() {
  theme_pubr(border = T,  legend = "top") +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
    
}

theme_classic_lines_45 <- function() {
  theme_pubr(border = T,  legend = "top", x.text.angle = 45) +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
}

theme_classic_lines_90 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 90) +
            theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.1),
                  strip.background = element_rect(fill = "#ced4da"))
}

theme_set(theme_classic_lines())

ggplot_cust <- function(...) ggplot2::ggplot(...) + 
  scale_color_manual(values = colors_diverse) + 
  scale_fill_manual(values = colors_diverse)

## save favorite colors
colors_diverse <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51")
colors_diverse_2 <- c("#CB997E", "#DDBEA9", "#FFE8D6", "#B7B7A4", "#A5A58D", "#6B705C")
colors_continous <- c("MCF7_KO" = "#DFE4DC", "MCF7_WT_DMSO" = "#CAD2C5", "MCF7_WT_Nutlin" = "#84A98C", "#52796F", "#354F52", "#2F3E46")
colors_continous_2 <- c("#F8F9FA", "#E9ECEF", "#DEE2E6", "#CED4DA", "#ADB5BD", "#6C757D", "#495057", "#343A40", "#212529")
reds <- c("#DD6B48", "#E38569", "#E7A08A", "#EDBBAB", "#EFC9BC")
colors_promoter <- c("#F6D289", "#ECD9B1", "#FBEDD0")
```

---

### Load data

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
# Import processed bc counts from the preprocessing step
cDNA_df <- read.csv("/DATA/usr/m.trauernicht/projects/P53_reporter_scan/data/gcf6502/results/mt20220906_reporter_activity_filt.csv", header = T) %>%
  filter(str_detect(condition, "K562", negate = T)) %>%
  filter(condition != "MCF7_KO_Nutlin")
cDNA_df <- cDNA_df[!is.na(cDNA_df$tf),]
cDNA_df$activity[is.na(cDNA_df$activity)] <- 0

# Remove outliers and recalculate mean activities
cDNA_df <- cDNA_df %>%
  mutate(reporter_activity = ave(reporter_activity, reporter_id, sample_id, FUN = function(x) mean(x)),
         log_reporter_activity = log2(reporter_activity))


# Change names
cDNA_df$tf <- as.character(cDNA_df$tf)
cDNA_df$condition[cDNA_df$condition == "MCF7"] <- "MCF7_WT_DMSO"
cDNA_df$condition[cDNA_df$condition == "MCF7_Nutlin"] <- "MCF7_WT_Nutlin"

# # Remove gcf6501 KO data because it looks like P53 regained activity there
# cDNA_df <- cDNA_df %>%
#   filter(sample != "MCF7_KO_DMSO_r1_gcf6501", sample != "MCF7_KO_DMSO_r2_gcf6501")
# cDNA_df <- cDNA_df %>%
#   filter(sample != "MCF7_KO_Nutlin_r1_gcf6501", sample != "MCF7_KO_Nutlin_r2_gcf6501")
# cDNA_df$sample[cDNA_df$sample == "MCF7_KO_DMSO_r1_gcf6412"] <- "MCF7_KO_DMSO_r1_gcf6501"
# cDNA_df$gcf[cDNA_df$sample == "MCF7_KO_DMSO_r1_gcf6501"]  <- "gcf6501"

# Check if the conditions are scaled correctly
ggplot_cust(cDNA_df %>% 
         filter(neg_ctrls == "Yes", str_detect(tf, "53"), str_detect(condition, "MCF")) %>% 
         dplyr::select(tf, condition, reporter_activity, reporter_id, gcf, promoter) %>% 
         unique(), 
       aes(x = condition, y = reporter_activity, color = tf)) + 
  geom_quasirandom(dodge.width = 0.75) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_grid(promoter~gcf)



### In the barcode-preprocessing script I already scaled the data so that the negative controls would have the same counts in all conditions
# Now I want to compute the enrichment over the inactive ones to center the data around 1 (1 = inactive)
cDNA_df_neg <- cDNA_df %>%
  dplyr::select(tf, sample_id, reporter_activity, reporter_id, neg_ctrls, promoter, condition) %>%
  mutate(tf = gsub("_.*", "", tf)) %>%
  filter(neg_ctrls == "Yes") %>%
  mutate(tf = gsub("(.*random[1-3]{1})_.*", "\\1", reporter_id)) %>%
  unique() %>%
  group_by(sample_id, promoter, tf) %>%
  mutate(reporter_activity = mean(reporter_activity)) %>%
  ungroup() %>%
  dplyr::select(-reporter_id) %>%
  unique() %>%
  distinct("background_activity" = reporter_activity, sample_id, promoter, tf, condition)

compare_neg <- cDNA_df_neg %>% 
  spread(key = "tf", value = "background_activity")

ggplot(compare_neg, 
       aes(x = GR_random1, y = GR_random2, color = condition)) +
  geom_point() +
  geom_abline() +
  facet_wrap(~promoter, scales = "free")


ggplot(cDNA_df_neg,
       aes(x = tf, y = background_activity)) +
  geom_point() +
  facet_wrap(~sample_id) +
  theme_classic_lines_90()

# cDNA_df_neg <- cDNA_df %>%
#   dplyr::select(tf, sample_id, reporter_activity, reporter_id, neg_ctrls, promoter) %>%
#   mutate(tf = gsub("_.*", "", tf)) %>%
#   filter(neg_ctrls == "Yes") %>%
#   mutate(tf = gsub("(.*random[1-3]{1})_.*", "\\1", reporter_id)) %>%
#   filter(tf == "GR_random2") %>%
#   unique() %>%
#   group_by(sample_id, promoter) %>%
#   mutate(reporter_activity = mean(reporter_activity)) %>%
#   ungroup() %>%
#   dplyr::select(-reporter_id) %>%
#   unique() %>%
#   dplyr::select("background_activity" = reporter_activity, sample_id, promoter) %>%
#   unique()

# For now remove gcf6412
cDNA_df <- cDNA_df %>%
  filter(sample_id != "MCF7_r1_gcf6412") %>%
  filter(!sample_id %in% c("MCF7_KO_r1_gcf6881", "MCF7_KO_Nutlin_r1_gcf6881", "MCF7_r1_gcf6881", "MCF7_Nutlin_r1_gcf6881"))

cDNA_df_neg <- cDNA_df %>%
  dplyr::select(tf, sample_id, reporter_activity, reporter_id, neg_ctrls, promoter) %>%
  mutate(tf = gsub("_.*", "", tf)) %>%
  filter(neg_ctrls == "Yes") %>%
  mutate(tf = gsub("(.*random[1-3]{1})_.*", "\\1", reporter_id)) %>%
  filter(tf %in% c("P53_random1", "P53_random2")) %>%
  unique() %>%
  group_by(sample_id, promoter) %>%
  mutate(reporter_activity = mean(reporter_activity)) %>%
  ungroup() %>%
  dplyr::select(-reporter_id) %>%
  unique() %>%
  dplyr::select("background_activity" = reporter_activity, sample_id, promoter) %>%
  unique()


cDNA_df <- cDNA_df %>%
  mutate(tf = gsub("_.*", "", tf))
cDNA_df <- merge(cDNA_df, cDNA_df_neg)
cDNA_df <- cDNA_df %>%
  mutate(reporter_activity_norm = reporter_activity / background_activity,
         activity_norm = activity / background_activity)


# Assign which pDNA library was used for which gcf

# Compute means per sample
cDNA_df$reporter_activity_condition <- ave(cDNA_df$reporter_activity_norm, cDNA_df$condition, cDNA_df$reporter_id, FUN = function(x) mean(x))
cDNA_df$reporter_activity_sample <- ave(cDNA_df$reporter_activity_norm, cDNA_df$sample_id, cDNA_df$reporter_id, FUN = function(x) mean(x))

# Check if the conditions are scaled correctly
ggplot_cust(cDNA_df %>% 
         filter(tf == "P53", neg_ctrls == "Yes", str_detect(condition, "MCF")) %>% 
         dplyr::select(tf, sample_id, reporter_activity_sample, reporter_id, gcf, promoter) %>% 
         unique(), 
       aes(x = sample_id, y = reporter_activity_sample, color = tf)) + 
  geom_quasirandom(dodge.width = 0.75) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_grid(gcf~promoter)

# Additional normalization
cDNA_df_neg2 <- cDNA_df %>%
  dplyr::select(tf, condition, reporter_activity_condition, reporter_id, neg_ctrls) %>%
  mutate(tf = gsub("_.*", "", tf)) %>%
  filter(neg_ctrls == "Yes") %>%
  mutate(tf = gsub("(.*random[1-3]{1})_.*", "\\1", reporter_id)) %>%
  filter(tf %in% c("GR_random1", "GR_random2")) %>%
  unique() %>%
  group_by(condition) %>%
  mutate(reporter_activity_condition = mean(reporter_activity_condition)) %>%
  ungroup() %>%
  dplyr::select(-reporter_id) %>%
  unique() %>%
  dplyr::select("condition_activity" = reporter_activity_condition, condition) %>%
  unique()

cDNA_df <- merge(cDNA_df, cDNA_df_neg2, by = "condition", all = T)
cDNA_df <- cDNA_df %>%
  mutate(reporter_activity_norm = reporter_activity_norm / condition_activity,
         activity_norm = activity_norm / condition_activity)

# Compute means per sample
cDNA_df$reporter_activity_condition <- ave(cDNA_df$reporter_activity_norm, cDNA_df$condition, cDNA_df$reporter_id, FUN = function(x) mean(x))
cDNA_df$reporter_activity_sample <- ave(cDNA_df$reporter_activity_norm, cDNA_df$sample_id, cDNA_df$reporter_id, FUN = function(x) mean(x))

# # Enrichment over KO condition
# ko_df <- cDNA_df %>%
#   filter(condition == "MCF7_KO") %>%
#   dplyr::select(reporter_id, "reporter_activity_condition_ko" = reporter_activity_condition) %>%
#   distinct()
# 
# 
# 
# cDNA_df <- merge(cDNA_df, ko_df, all = T, by = "reporter_id") %>%
#   mutate(reporter_activity_condition = reporter_activity_condition/reporter_activity_condition_ko)
```

---

## Figure 1: Characterize P53 activities per condition

Aim: I want to characterize the reporter activity distributions in the tested conditions. Does Nutlin boost P53 reporter activity and is P53 inactive in the KO cells?
```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure S1C: Correlate the three replicates:
compare_df <- cDNA_df %>%
  mutate(id = paste(gcf, replicate, sep = "_")) %>%
  filter(tf == "P53", neg_ctrls == "No", motif_id != "4_4_4_4", promoter != "random") %>%
  dplyr::select(reporter_id, reporter_activity_sample, condition, id) %>%
  unique() %>%
  mutate(reporter_id = paste(reporter_id, condition, sep = "_")) %>%
  pivot_wider(names_from = id, values_from = reporter_activity_sample) %>%
  column_to_rownames("reporter_id") %>%
  mutate(condition = factor(condition, levels = c("MCF7_WT_Nutlin", "MCF7_WT_DMSO", "MCF7_KO")))

p1 <- ggplot(compare_df %>%
               arrange(condition),
             aes(x = gcf6502_r1, y = gcf6502_r2)) +
  geom_abline(lty = 2)+
  geom_point_rast(alpha = 0.2, stroke = 0, raster.dpi=600) +
  xlim(0,150) +
  ylim(0,150) +
  #scale_color_manual(values = colors_continous) +
  geom_smooth(method = "lm", color = "#EBBE9B")

p2 <- ggplot(compare_df%>%
               arrange(condition),
             aes(x = gcf6502_r1, y = gcf6881_r2)) +
  geom_abline(lty = 2)+
  geom_point_rast(alpha = 0.2, stroke = 0, raster.dpi=600) +
  xlim(0,150) +
  ylim(0,150) +
  #scale_color_manual(values = colors_continous) +
  geom_smooth(method = "lm", color = "#EBBE9B")


p3 <-ggplot(compare_df%>%
               arrange(condition),
             aes(x = gcf6502_r2, y = gcf6881_r2)) +
  geom_abline(lty = 2)+
  geom_point_rast(alpha = 0.2, stroke = 0, raster.dpi=600) +
  xlim(0,150) +
  ylim(0,150) +
  #scale_color_manual(values = colors_continous) +
  geom_smooth(method = "lm", color = "#EBBE9B")


plot_grid(p1, p2, p3, nrow = 2)


cor(compare_df$gcf6502_r1, compare_df$gcf6502_r2, method = "spearman", use = "pairwise.complete.obs")
cor(compare_df$gcf6502_r1, compare_df$gcf6881_r2, method = "spearman", use = "pairwise.complete.obs")
cor(compare_df$gcf6881_r2, compare_df$gcf6502_r2, method = "spearman", use = "pairwise.complete.obs")



## Figure 1E: Reporter activity per condition, compared to negative and positive controls
data <- cDNA_df %>%
           dplyr::select(reporter_activity_condition, positive_ctrl, promoter, condition, neg_ctrls, affinity_id, tf, condition, reporter_id, positive_ctrl) %>%
           filter(promoter != "random", tf == "P53", 
                  affinity_id != "1_null_only", str_detect(condition, "KO_Nutlin", negate = T)) %>%
           ungroup() %>%
           unique()

colors_new2 <- c(colors_continous, c("neg_ctrl" = "black", "pos_ctrl" = "red"))
ggplot(data %>%
         mutate(condition2 = ifelse(neg_ctrls == "Yes", "neg_ctrl", condition)) %>%
         mutate(condition2 = ifelse(positive_ctrl == "Yes", "pos_ctrl", condition2)) %>%
         mutate(condition2 = factor(condition2, levels = c("MCF7_KO", "MCF7_WT_DMSO", "MCF7_WT_Nutlin", "neg_ctrl", "pos_ctrl"))) %>%
         arrange(condition2), 
       aes(y = reporter_activity_condition, x = condition)) + 
  geom_quasirandom_rast(aes(color = condition2), stroke = 0, alpha = 1, size = 1, raster.dpi = 600, bandwidth = 0.4, width = 0.35, method = "smiley") + 
  xlab("condition") + 
  scale_color_manual(values = colors_new2) +
  ylab("reporter activity")
```

Conclusion: S1C: Replicates do correlate well. 1E: Negative controls are inactive compared to P53 reporters. P53 reporters become more active in WT cells and even more active upon Nutlin stimulation. 


---

## Figure 2: Reporter framework

Aim: Show that the reporter framework influences reporter activity. Reporter framework = background + promoter. Also show the impact of copy number and positioning of binding sites. 

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 2A: reporter activity distribution - compare promoters
ggplot(cDNA_df %>%
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")) %>%
         filter(neg_ctrls == "No",
                motif_id != "4_4_4_4", tf == "P53") %>%
         dplyr::select(condition, reporter_activity_condition, reporter_id, positive_ctrl, promoter, tf) %>%
         unique(),
       aes(x = condition, y = reporter_activity_condition, fill = promoter)) + 
  geom_quasirandom_rast(dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600, bandwidth = 0.4, width = 0.1, method = "smiley") + 
  geom_boxplot(position = position_dodge(0.75), alpha = 0.8, outlier.shape = NA)+
  xlab("") + 
  ylab("reporter activity (a.u.)") +
  labs(title = "reporter activity distribution per minimal promoter") +
  scale_fill_manual(values = colors_promoter)+ 
  stat_compare_means(method = "t.test") 

## Figure S2B: reporter activity distribution - only random reporters
ggplot(cDNA_df %>%
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")) %>%
         filter(neg_ctrls == "No", promoter == "random",
                motif_id != "4_4_4_4", tf == "P53") %>%
         dplyr::select(condition, reporter_activity_condition, reporter_id, positive_ctrl, promoter, tf) %>%
         unique(),
       aes(x = condition, y = reporter_activity_condition, fill = promoter)) + 
  geom_quasirandom_rast(dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600) + 
  geom_boxplot(position = position_dodge(0.75), alpha = 0.8, outlier.shape = NA)+
  xlab("") + 
  ylab("reporter activity (a.u.)") +
  labs(title = "reporter activity distribution per minimal promoter") +
  scale_fill_manual(values = colors_promoter)+ 
  stat_compare_means(method = "t.test") 

## Figure 2B: impact of background sequence
ggplot(cDNA_df %>% 
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin"))%>%
         filter(neg_ctrls == "No", positive_ctrl == "No", promoter != "random", 
                str_detect(affinity_id, "[9]_", negate = T), 
                tf == "P53") %>%
         dplyr::select(tf, reporter_activity_condition, background, reporter_id, condition, affinity_id, promoter) %>% 
         unique(), aes(x = condition, y = reporter_activity_condition, color = factor(background))) +
  geom_quasirandom_rast(dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600, bandwidth = 0.4, width = 0.1) + 
  geom_boxplot(position = position_dodge(.75), alpha = .7, outlier.shape = NA)+
  scale_color_manual(values = c("#000000","#666666", "#999999"))+
  labs(title = "reporter activity per background")+
  xlab("background sequence")+
  ylab("reporter activity")+
  facet_wrap(~promoter)+ 
  stat_compare_means(method = "t.test") 

## Figure S2C: correlate minP and mCMV reporter activities
data <- cDNA_df %>%
  filter(neg_ctrls == "No", positive_ctrl == "No", promoter != "random", motif_id != "4_4_4_4", tf == "P53") %>%
  dplyr::select(tf, reporter_activity_condition, n_sites, motif_id, condition, reporter_id_2, background, promoter) %>% 
  unique() %>%
  spread(promoter, reporter_activity_condition) %>% 
  na.omit()

ggplot(data %>% 
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")), aes(x = minP, y = mCMV)) +
  geom_abline(lty = 2) + 
  geom_abline(slope = mean(data$mCMV)/mean(data$minP), linetype = 1) +
  geom_smooth(method = "lm", aes(color = factor(background), fill = factor(background)), alpha = 0.4) +
  geom_point(size = 1.5, aes(color = factor(background)), stroke = 0) +
  scale_color_manual(values = c("#000000","#666666", "#999999")) +
  scale_fill_manual(values = c("#000000","#666666", "#999999")) +
  facet_wrap(~background) + 
  ylim(0,120) + 
  xlim(0,120) 


## Figure S2A: minimal promoters background activity
data <- cDNA_df %>%
  filter(neg_ctrls == "Yes", positive_ctrl == "No",tf == "P53") %>%
  dplyr::select(tf, reporter_activity, n_sites, motif_id, condition, reporter_id, background, promoter) %>% 
  mutate(reporter_activity_condition = ave(reporter_activity, reporter_id, condition, FUN = mean)) %>%
  dplyr::select(-reporter_activity) %>%
  unique() %>%
  na.omit()

ggplot(data, aes(x = promoter, y = reporter_activity_condition)) +
  geom_quasirandom_rast(stroke = 0, alpha = 1, size = 1, raster.dpi = 600) + 
  geom_boxplot(aes(fill = promoter), alpha = .8) +
  scale_fill_manual(values = c("#F6D289", "#ECD9B1", "#FBEDD0"))

# Figure S2D: reporters with 0bp spacing
data <- cDNA_df %>%
  filter(neg_ctrls == "No", positive_ctrl == "No", promoter != "random", motif_id != "4_4_4_4", spacing == 0, tf == "P53") %>%
  dplyr::select(tf, reporter_activity_condition, n_sites, motif_id, condition, reporter_id_2, background, promoter) %>% 
  unique()%>%
  spread(promoter, reporter_activity_condition) %>% 
  na.omit()

ggplot(data %>% 
         filter(condition %in% c("MCF7_WT_DMSO","MCF7_WT_Nutlin")), 
       aes(x = minP, y = mCMV)) +
  geom_abline(lty = 2) + 
  geom_abline(slope = mean(data$mCMV)/mean(data$minP), linetype = 1) +
  geom_point(aes(color = factor(background)), size = 2, stroke = 0) +
  geom_smooth(se = T, method = "lm", aes(color = factor(background), fill = factor(background))) +
  scale_color_manual(values = c("#000000","#666666", "#999999")) +
  scale_fill_manual(values = c("#000000","#666666", "#999999")) +
  facet_wrap(~background) + 
  ylim(0,80) + 
  xlim(0,80) 


## Figure 2C: Effect of adding binding sites
ggplot(cDNA_df %>%
         filter(neg_ctrls == "No", positive_ctrl == "No",promoter == "mCMV", 
                str_detect(condition, "MCF7_WT"), str_detect(motif_id, "4_4_4_4|4_4_4_3|4_4_3_3|4_3_3_3|3_3_3_3"), 
                tf == "P53", spacing == 7) %>%
         dplyr::select(tf, reporter_activity_condition, n_sites, condition, reporter_id, promoter) %>% 
         unique() %>%
         mutate(reporter_activity_condition_sd = ave(reporter_activity_condition, n_sites, promoter, condition, FUN = function(x) sd(x))) %>%
         mutate(reporter_activity_condition = ave(reporter_activity_condition, n_sites, promoter, condition, FUN = function(x) mean(x))) %>%
         unique(), 
       aes(x = n_sites, y = reporter_activity_condition, fill = condition)) +
  geom_errorbar(aes(ymin=reporter_activity_condition-reporter_activity_condition_sd, ymax=reporter_activity_condition+reporter_activity_condition_sd), width=.2, position=position_dodge(.9)) +
  geom_bar(stat = "identity", position = position_dodge(0.8), width = 0.9, color = "white")+
  ggtitle("reporter activity vs number of binding sites")+
  xlab("number of low-affinity binding sites")+
  ylab("reporter activity (a.u.)")+
  scale_fill_manual(values = colors_continous)



## Figure 2D: activity for different number of binding sites - the positioning effect
data <- cDNA_df %>%
         filter(neg_ctrls == "No", positive_ctrl == "No", promoter == "mCMV", 
                str_detect(condition, "MCF7_WT"), str_detect(condition, "PFT", negate = T), str_detect(affinity_id, "[7-9]_"), 
                tf == "P53", spacing == 7) %>%
         dplyr::select(tf, reporter_activity_condition, n_sites, motif_id, condition, affinity_id, gcf) %>% 
         unique() %>%
         mutate(reporter_activity_condition = ave(reporter_activity_condition, motif_id, condition, FUN = function(x) mean(x))) %>%
         unique()

ggplot(data, 
       aes(x = n_sites, y = reporter_activity_condition, color = condition)) +
  geom_point(position = position_dodge(0.75), size = 3, stroke = 0)+
  geom_label(data = data %>% 
               filter(n_sites != 0, n_sites != 4) %>%
               dplyr::select(reporter_activity_condition, motif_id, condition, n_sites) %>%
               arrange(desc(reporter_activity_condition)) %>% 
               group_by(n_sites) %>% 
               slice_head(n=3), 
             aes(label = motif_id), 
             nudge_x = -.3) +
  ggtitle("reporter activity vs number of binding sites")+
  xlab("number of low-affinity binding sites")+
  ylab("reporter activity (a.u.)")+
  scale_color_manual(values = colors_continous)



## Figure 2E+F: Fit model to predict position and copy number effect

# Rule of thumb for fitting models: e^n_features < n_observations

# Subselect p53 only 
cDNA_df_p53 <- cDNA_df %>%
  filter(neg_ctrls == "No", positive_ctrl == "No",tf == "P53", motif_id != "4_4_4_4",
         spacing == 7, str_detect(affinity_id, "[7-9]"), position == 0, 
         promoter == "mCMV", str_detect(condition, "MCF7_WT_Nutlin"), str_detect(condition, "PFT", negate = T)) %>%
  dplyr::select(reporter_id, condition, reporter_activity_condition,
                affinity_pos1, affinity_pos2, affinity_pos3, affinity_pos4, motif_id, n_sites) %>% 
  mutate(reporter_activity = ave(reporter_activity_condition, motif_id, condition, FUN = function(x) mean(x)),
         log_reporter_activity = log2(reporter_activity)) %>%
  dplyr::select(-reporter_id, - reporter_activity_condition) %>%
  unique()

cDNA_df_p53$highest_dist <- "0"
cDNA_df_p53$highest_dist[grep("3_4_3", cDNA_df_p53$motif_id)] <- "1"
cDNA_df_p53$highest_dist[grep("3_4_4_3", cDNA_df_p53$motif_id)] <- "1"

cDNA_df_p53$n_adjacent <- 0
cDNA_df_p53$n_adjacent[grep("3_3", cDNA_df_p53$motif_id)] <- 1
cDNA_df_p53$n_adjacent[grep("3_3_3", cDNA_df_p53$motif_id)] <- 2

cDNA_df_p53$motif_dist <- 1
cDNA_df_p53$motif_dist[grep("3_4_4$", cDNA_df_p53$motif_id)] <- 2
cDNA_df_p53$motif_dist[grep("3_4$", cDNA_df_p53$motif_id)] <- 3
cDNA_df_p53$motif_dist[grep("3$", cDNA_df_p53$motif_id)] <- 4

cDNA_df_p53$n_sites <- as.character(cDNA_df_p53$n_sites)

cDNA_df_p53$n_sites_spacer <- paste(cDNA_df_p53$n_sites, cDNA_df_p53$highest_dist, sep = "_")
cDNA_df_p53$n_sites_spacer <- factor(cDNA_df_p53$n_sites_spacer, levels = c("1_0","2_0","3_0","4_0","2_1", "3_1"))

# Rename 0,1,2,3,4 in null, very-weak, weak, medium, strong
replace <- data.frame("old" = c(0:4), "new" = c("_4_strong", "_3_medium", "_2_weak", "_1_very-weak", "_0_null"), stringsAsFactors=FALSE)
for (i in unique(replace$old)) {
  cDNA_df_p53$affinity_pos1[cDNA_df_p53$affinity_pos1 == i] <- replace$new[replace$old == i]
  cDNA_df_p53$affinity_pos2[cDNA_df_p53$affinity_pos2 == i] <- replace$new[replace$old == i]
  cDNA_df_p53$affinity_pos3[cDNA_df_p53$affinity_pos3 == i] <- replace$new[replace$old == i]
  cDNA_df_p53$affinity_pos4[cDNA_df_p53$affinity_pos4 == i] <- replace$new[replace$old == i]
}

## Explain which affinities are essential at which position to boost activity
cDNA_df_p53 <- cDNA_df_p53[order(cDNA_df_p53$condition),] %>%
  dplyr::select(-motif_id)
cDNA_df_p53$row <- rownames(cDNA_df_p53)

## Fitting the model
x <- lm(reporter_activity ~ n_sites_spacer + motif_dist, cDNA_df_p53)

summ(x)
par(mfrow=c(2,2))
plot(x, main = i)

# Get predicted activities per reporter
y <- data.frame(x$fitted.values, stringsAsFactors=FALSE) %>% rownames_to_column()
names(y) <- c("row", "reporter_activity_predicted")
y$id <- 1:nrow(y)
prediction <- data.frame("id" = 1:(nrow(cDNA_df_p53)), stringsAsFactors=FALSE)
prediction <- merge(prediction,y, all = T) %>% 
  dplyr::select(-id)
cDNA_df_p53 <- merge(cDNA_df_p53, prediction)
  

# What are the individual weights?
weight <- data.frame(x$coefficients, stringsAsFactors=FALSE) %>% rownames_to_column()
names(weight) <- c("feature", "weight")
weight <- weight %>% filter(feature != "(Intercept)")
categorie <- c("affinity_pos", "n_sites", "highest_dist")
weight$features <- gsub(paste(categorie, collapse="|"), "",weight$feature)
weight$cond <- gsub(paste(weight$features, collapse = "|"), "", weight$feature)
  

# How many percent do the different tested features explain?
exp_variance <- anova(x) %>% rownames_to_column("feature") %>%
  setnames("Sum Sq", "sum_sq") %>%
  dplyr::select(feature, sum_sq) %>%
  mutate(sum = sum(sum_sq)) %>%
  mutate(rel_sum_sq = (sum_sq/sum)*100) %>%
  setnames("rel_sum_sq", "percent") %>%
  dplyr::select("feature", "percent")

exp_variance$group <- "no residual"
exp_variance$group[grep("Residual", exp_variance$feature)] <- "residual"
exp_variance$percent[exp_variance$feature == "Residuals"] <- 100 - exp_variance$percent[exp_variance$feature == "Residuals"]
exp_variance$feature <- revalue(exp_variance$feature, c("Residuals"="total"))


# Plotting
ggplot(exp_variance, 
       aes(x = percent, y = reorder(feature, -percent), fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  xlab("Variance explained (%)") + 
  ylab("") + 
  labs(title = "Linear variance modelling", 
       subtitle = "Expression variance predicted by features") +
  theme_pubr(border = T) +
  theme(text = element_text(size = 12)) +
  guides(fill = F)

ggscatter(cDNA_df_p53, x = "reporter_activity", y = "reporter_activity_predicted",
          add = "reg.line",
          add.params = list(color = "#84A98C", fill = "lightgray"),
          conf.int = TRUE, ylab = "Predicted reporter activity", size = 3,
          xlab = "Average reporter activity") + 
  stat_cor(aes(label = ..r.label..), method = "pearson", label.x = 0, label.y = 3) +
  theme_classic_lines()

ggplot(weight, 
       aes(x = reorder(feature, -weight), y = weight)) +
  geom_bar(stat = "identity", width = 0.9, fill = "grey80", color = "white") + 
  ylab("weight - reporter activity") +
  xlab("") +
  guides(fill = F)
```

Conclusion: mCMV is the strongest, minimal promoter interacts with upstream background sequences.

---

Figure 3: Binding site affinity and spacing

Aim: Show how P53 affinity and binding site spacing affect reporter activity. 

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 3A: Demonstrate differences in reporter activities between DMSO and Nutlin
compare_df <- cDNA_df %>%
  filter(tf == "P53", motif_id != "4_4_4_4", promoter != "random") %>%
  dplyr::select(reporter_id, reporter_activity_condition, condition, neg_ctrls, tf, promoter, positive_ctrl, motif_id, SumAffinity) %>%
  unique() %>%
  pivot_wider(names_from = condition, values_from = reporter_activity_condition) %>%
  mutate(dif = MCF7_WT_Nutlin / MCF7_WT_DMSO) %>%
  na.omit()

ggplot() +
  geom_point(data = compare_df %>% filter(neg_ctrls == "No" & positive_ctrl == "No"), aes(x = MCF7_WT_DMSO, y = MCF7_WT_Nutlin, color = SumAffinity), size = 1) +
  scale_color_gradient(low = "#F7E4DE", high = reds[1]) +
  geom_point(data = compare_df %>% filter(neg_ctrls == "Yes"), aes(x = MCF7_WT_DMSO, y = MCF7_WT_Nutlin), color = "black") +
  #geom_point(data = compare_df %>% filter(positive_ctrl == "Yes"), aes(x = MCF7_WT_DMSO, y = MCF7_WT_Nutlin), color = "blue") +
  geom_abline(linetype = "dashed") 

compare_df2 <- compare_df
compare_df2$dif[compare_df2$dif > 5] <- 5

ggplot() +
  geom_point(data = compare_df2 %>% filter(neg_ctrls == "No"), aes(x = MCF7_WT_DMSO, y = MCF7_WT_Nutlin, color = dif), size = 1) +
  scale_color_gradient(low = "#DBE6DD", high = colors_continous[3]) +
  geom_point(data = compare_df2 %>% filter(neg_ctrls == "Yes"), aes(x = MCF7_WT_DMSO, y = MCF7_WT_Nutlin), color = "black") +
  geom_abline(linetype = "dashed") +
  theme(legend.position = "none")


## Figure S3A: Activity in the KO condition
ggplot(compare_df2 %>% 
         filter(motif_id %in% c("0_0_0_0", "1_1_1_1", "2_2_2_2", "3_3_3_3")) %>% 
         filter(neg_ctrls == "No", positive_ctrl == "No"), 
       aes(x = motif_id, y = MCF7_KO, color = motif_id)) +
  geom_quasirandom_rast(stroke = 0, alpha = 1, size = 1, raster.dpi = 600) + 
  geom_boxplot(alpha = 0.8, outlier.shape = NA)+
  scale_color_manual(values = reds) 


## DMSO vs Nutlin depending on reporter affinity
x <- cDNA_df %>%
         filter(neg_ctrls == "No", 
                #positive_ctrl == "No", 
                promoter == "mCMV",
                str_detect(condition, "MCF7_WT"),
                tf == "P53", 
                background == 2, 
                spacing == 7, 
                (position == 0 & n_sites == 4 & str_detect(affinity_id, "[1,2,3,4,5,6,7]{1}_")),
                str_detect(affinity_id, "10_high_start|11_high_mid|12_high_end", negate = T)) %>%
         dplyr::select(reporter_activity_condition, condition, SumAffinity, reporter_id, affinity_id, promoter, positive_ctrl) %>%
         unique() %>%
         mutate(reporter_activity_condition = ave(reporter_activity_condition, promoter, condition, SumAffinity,
                                                  FUN = function(x) mean(x))) %>%
         unique() %>%
         arrange(SumAffinity) %>%
         group_by(condition) %>%
         mutate(SumAffinity = 1:length(SumAffinity)) %>%
         spread(condition, reporter_activity_condition) %>%
         mutate(dif = MCF7_WT_Nutlin / MCF7_WT_DMSO)

x$copies <- "mixed"
x$copies[grep("[1,3,5,7]_", x$affinity_id)] <- "non_mixed"

ggplot() +
  geom_point(data = x %>% filter(positive_ctrl == "No"), aes(x = MCF7_WT_DMSO, y = log2(dif), color = SumAffinity, shape = copies), size = 2) +
    geom_point(data = x %>% filter(positive_ctrl == "Yes"), aes(x = MCF7_WT_DMSO, y = log2(dif)), color = "black", size = 2) +
  scale_color_gradient2(low = "grey", mid = "#F9E9E4", high = reds[1], midpoint = 24) +
  geom_hline(yintercept = 0, lty = 2) +
  labs(title = "reporter activity per affinity")

ggplot() +
  geom_point(data = x %>% filter(positive_ctrl == "No"), aes(y = dif, x = SumAffinity, color = dif, shape = copies), size = 2) +
  scale_color_gradient2(low = "grey90", mid = colors_continous[1], high = colors_continous[3], midpoint = 1) +
  geom_hline(yintercept = 1, lty = 2) +
  labs(title = "reporter activity per affinity")

## Figure 3C: activity per affinity
colors_new <- c("1_high_only" = reds[1], "3_med_only" = reds[2], "5_low_only" = reds[3], "7_very-low_only" = reds[4], "9_null_only" = reds[5], colors_continous[c(1,2,3)])
ggplot(cDNA_df %>%
           filter(neg_ctrls == "No", promoter == "mCMV", positive_ctrl == "No", spacing == 7, tf == "P53",
                  #str_detect(condition, "MCF7_WT"),
                  str_detect(affinity_id, "[1,3,5,7,9]_"), str_detect(affinity_id, "11_high_mid", negate = T)) %>%
           dplyr::select(tf, reporter_activity_condition, background, reporter_id, condition, affinity_id) %>%
           unique(), 
       aes(x = affinity_id, y = reporter_activity_condition)) +    
  geom_quasirandom(dodge.width = .75, aes(color = affinity_id, group = condition)) +
  geom_boxplot(position = position_dodge(.75), aes(color = condition), alpha = 0.7, outlier.shape = NA) +
  xlab("") +
  scale_fill_manual(values = colors_new) +
  scale_color_manual(values = colors_new) +
  stat_compare_means(method = "t.test") 


## Figure S3C: Show that 4 copies + 7 bp spacing is not the ideal set
cDNA_df_cor_mcf <- cDNA_df %>%
  filter(str_detect(sample, "MCF"), str_detect(sample, "KO", negate = T), str_detect(sample, "PFT", negate = T),
         tf == "P53", neg_ctrls == "No", positive_ctrl == "No") %>%
  dplyr::select(reporter_id, reporter_activity_condition, condition, spacing, n_sites, promoter, motif_id) %>%
  unique()

cDNA_df_cor_mcf$design <- "alt"
cDNA_df_cor_mcf$design[cDNA_df_cor_mcf$n_sites == 4 & cDNA_df_cor_mcf$spacing == 7] <- "common"

ggplot(cDNA_df_cor_mcf %>% 
         filter(motif_id != "4_4_4_4", promoter == "mCMV") %>%
         na.omit(), 
       aes(x = design, y = reporter_activity_condition, color = condition)) +
 geom_quasirandom_rast(dodge.width = .75, stroke = 0, alpha = 1, size = 1, raster.dpi = 600, width = 0.2) + 
  geom_boxplot(position = position_dodge(0.75), alpha = 0.8, outlier.shape = NA)+
  scale_color_manual(values = colors_continous)
```

Conclusion:

---

## Figure 4: Spacing effect

Aim: Show how binding site spacing affects reporter activity.

```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Figure 4A: activity per spacing at different affinities - lib 2 all data combined
ggplot(cDNA_df %>%
         filter(neg_ctrls == "No", promoter == "mCMV", positive_ctrl == "No",
                str_detect(affinity_id, "[1,3,5,7]{1}_"), str_detect(affinity_id, "11_high_mid", negate = T),
                position == 0, tf == "P53") %>%
         dplyr::select(tf, reporter_activity_condition, reporter_id, spacing, condition, affinity_id) %>% 
         unique() %>%
         mutate(reporter_activity_spacing = ave(reporter_activity_condition, affinity_id, condition, spacing, FUN = function(x) mean(x))) %>%
         unique(), 
       aes(x = spacing, y = reporter_activity_spacing, color = condition, fill = condition)) +
  geom_point() +
  geom_smooth()+
  theme_pubr(border = T) +
  ggtitle("reporter activity per spacing")+
  xlab("spacing length between motifs (bp)")+
  ylab("reporter activity (a.u.)")+
  scale_color_manual(values = colors_continous)+
  scale_fill_manual(values = colors_continous)+
  facet_wrap(~affinity_id, nrow = 2) +
  scale_x_continuous(breaks = seq(0,10,1))

ggplot(cDNA_df %>%
         filter(neg_ctrls == "No", promoter == "mCMV", positive_ctrl == "No",
                str_detect(affinity_id, "[1,3,5,7]{1}_"), str_detect(affinity_id, "11_high_mid", negate = T),
                position == 0, tf == "P53") %>%
         dplyr::select(tf, reporter_activity_condition, spacing, reporter_id, condition, affinity_id) %>% 
         unique() %>%
         mutate(reporter_activity_condition = ave(reporter_activity_condition, affinity_id, condition, spacing, FUN = function(x) mean(x))) %>%
         unique() %>%
         spread(key = "condition", value = "reporter_activity_condition") %>%
         mutate(dif = MCF7_WT_Nutlin/ MCF7_WT_DMSO), 
       aes(x = spacing, y = dif)) +
  geom_point() +
  geom_smooth(color = colors_continous[3])+
  theme_pubr(border = T) +
  ggtitle("reporter activity per spacing")+
  xlab("spacing length between motifs (bp)")+
  ylab("reporter activity (a.u.)")+
  facet_wrap(~affinity_id, nrow = 2) +
  scale_x_continuous(breaks = seq(0,10,1))

## Figure S4A: Show that some reporters are superior to commercial reporters
compare_df <- cDNA_df %>%
  filter(tf == "P53", motif_id != "4_4_4_4", promoter != "random") %>%
  dplyr::select(reporter_id, reporter_activity_condition, condition, neg_ctrls, tf, promoter, positive_ctrl, motif_id, SumAffinity, spacing) %>%
  unique() %>%
  pivot_wider(names_from = condition, values_from = reporter_activity_condition) %>%
  mutate(dif = MCF7_WT_Nutlin / MCF7_KO_DMSO) %>%
  na.omit()

ggplot(compare_df %>%
         filter(neg_ctrls == "No", str_detect(motif_id,"2", negate = T)) %>%
         mutate(spacing = factor(spacing, levels = c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))),
       aes(x = MCF7_WT_Nutlin, y = dif)) +
  geom_hline(yintercept = 1, lty = 2) +
  geom_point(shape = 21, aes(fill = spacing, color = positive_ctrl), size = 2) +
  scale_color_manual(values = c("black", "red"))  +
  geom_label(data = compare_df %>% 
               filter(neg_ctrls == "No", str_detect(motif_id,"2", negate = T)) %>%
               filter(dif > 70 | MCF7_WT_Nutlin > 85), 
             aes(label = motif_id), 
             nudge_y = +6,
             color = "black") +
  scale_fill_manual(values = rev(c("grey100", "grey90", "grey80", "grey40", "grey20", "grey0", "grey20", "grey40", "grey80", "grey90", "grey100")))

## Four BSs at 1 bp vs two BSs
compare_df2 <- cDNA_df %>%
  filter(tf == "P53", motif_id != "4_4_4_4", promoter == "minP") %>%
  dplyr::select(reporter_id, reporter_activity_condition, condition, neg_ctrls, tf, promoter, positive_ctrl, motif_id, SumAffinity, spacing, n_sites) %>%
  unique() %>%
  pivot_wider(names_from = condition, values_from = reporter_activity_condition) %>%
  mutate(dif = MCF7_WT_Nutlin / MCF7_WT_DMSO) %>%
  na.omit() %>%
  filter((motif_id == "3_3_3_3" & spacing == 1) | 
           (n_sites == 2 & str_detect(motif_id, "3_4_3")) 
         #| 
           #(n_sites == 3 & str_detect(motif_id, "3_4_3"))
         ) %>%
  mutate(reporter_activity_condition = ave(MCF7_WT_Nutlin, n_sites, FUN = mean)) %>%
    mutate(reporter_activity_condition_sd = ave(MCF7_WT_Nutlin, n_sites, FUN = sd)) 

ggplot(compare_df2 %>%
         mutate(n_sites = as.factor(n_sites)),
       aes(x = n_sites, y = reporter_activity_condition, fill = n_sites)) +
  geom_errorbar(aes(ymin=reporter_activity_condition-reporter_activity_condition_sd, ymax=reporter_activity_condition+reporter_activity_condition_sd), width=.2, position=position_dodge(.9)) +
  geom_bar(stat = "identity", position = position_dodge(0.8), width = 0.9, color = "white") +
  scale_fill_manual(values = rev(reds))
  

## Line-plot comparing sensitivities of my reporters to positive controls
compare_df2 <- cDNA_df %>%
  filter(tf == "P53", motif_id != "4_4_4_4", promoter != "random") %>%
  filter(reporter_id %in% c("P53_minP_p_0_s_7_d_10_bg_3_a1_4_a2_3_a3_4_a4_3", "P53_minP_p_70_s_7_d_10_bg_2_a1_0_a2_0_a3_0_a4_0", 
                            "P53_minP_p_0_s_1_d_10_bg_3_a1_3_a2_3_a3_3_a4_3", "P53_mCMV_p_70_s_7_d_10_bg_1_a1_0_a2_0_a3_0_a4_0")) %>%
  dplyr::select(reporter_id, reporter_activity_condition, condition, neg_ctrls, tf, promoter, positive_ctrl, motif_id, SumAffinity, spacing) %>%
  unique() 

## Figure 4B: activity per spacing at different affinities - only low_affinity, background 3
ggplot(compare_df2,
       aes(x = condition, y = reporter_activity_condition, color = reporter_id, group = reporter_id)) +
  geom_point() +
  geom_line() +
  ggtitle("reporter activity per spacing")+
  xlab("spacing length between motifs (bp)")+
  ylab("Reporter activity")+
  scale_color_manual(values = c("red", "grey60",  "grey10", "red"))



## Rule of thumb for fitting models: e^n_features < n_observations -> I will try to fit 20 features for 282 observations

## Subselect reporters
cDNA_df_p53 <- cDNA_df %>%
  filter(neg_ctrls == "No", positive_ctrl == "No",tf == "P53",
         position == 0, promoter == "mCMV", 
         affinity_id %in% c(
           #"1_high_only", 
                            #"3_med_only", 
                            #"5_low_only", 
                            "7_very-low_only", "8_very-low_null")) %>%
  dplyr::select(condition, reporter_activity_condition, 
                affinity_pos1, spacing, n_sites, motif_id, affinity_id) %>%
  mutate(spacing = as.factor(spacing),
         #background = as.factor(background),
         reporter_activity = ave(reporter_activity_condition, motif_id, condition, n_sites, spacing, FUN = function(x) mean(x))) %>%
  dplyr::select(-reporter_activity_condition) %>%
  unique() %>%
  spread(key = "condition", value = "reporter_activity") %>%
  mutate(dif = MCF7_WT_Nutlin / MCF7_WT_DMSO) %>%
  mutate(MCF7_WT_Nutlin = MCF7_WT_Nutlin) %>%
  mutate(n_sites = as.character(n_sites))%>%
  mutate(affinity_pos1 = ifelse(affinity_id == "8_very-low_null", "3", affinity_pos1)) %>%
  distinct() %>%
  mutate(spacing = factor(spacing, levels = c("7", "0", "1", "2", "3", "4", "5", "6", "8", "9", "10"))) 

cDNA_df_p53$motif_dist <- 1
cDNA_df_p53$motif_dist[grep("3_4_4$", cDNA_df_p53$motif_id)] <- 2
cDNA_df_p53$motif_dist[grep("3_4$", cDNA_df_p53$motif_id)] <- 3
cDNA_df_p53$motif_dist[grep("3$", cDNA_df_p53$motif_id)] <- 4

cDNA_df_p53$highest_dist <- "0"
cDNA_df_p53$highest_dist[grep("3_4_3", cDNA_df_p53$motif_id)] <- "1"
cDNA_df_p53$highest_dist[grep("3_4_4_3", cDNA_df_p53$motif_id)] <- "1"

cDNA_df_p53 <- cDNA_df_p53 %>%
  mutate(n_sites_spacing_dist = paste(n_sites, spacing, highest_dist, sep = "_")) %>%
  mutate(n_sites_spacing_dist = factor(n_sites_spacing_dist, levels = c("1_7_0", "2_7_0", "2_7_1", "3_7_0", "3_7_1", "4_0_0",  "4_1_0",  "4_2_0",  "4_3_0", "4_4_0", "4_5_0", "4_6_0",   "4_7_0", "4_8_0", "4_9_0", "4_10_0")))

cDNA_df_p53$n_adjacent <- 0
cDNA_df_p53$n_adjacent[grep("3_3", cDNA_df_p53$motif_id)] <- 1
cDNA_df_p53$n_adjacent[grep("3_3_3", cDNA_df_p53$motif_id)] <- 2

# Rename 0,1,2,3,4 in null, very-weak, weak, medium, strong
replace <- data.frame("old" = c(0:4), "new" = c("motif 1", "motif 2", "motif 3", "motif 4", "motif 0"), stringsAsFactors=FALSE)
for (i in unique(replace$old)) {
  cDNA_df_p53$affinity_pos1[cDNA_df_p53$affinity_pos1 == i] <- replace$new[replace$old == i]
}

## First for DMSO
cDNA_df_p53_dmso <- cDNA_df_p53
cDNA_df_p53_dmso$row <- rownames(cDNA_df_p53_dmso)

## Fitting the model
x <- lm(dif ~ n_sites_spacing_dist, cDNA_df_p53_dmso)

summ(x)
par(mfrow=c(2,2))
plot(x)

# Get predicted activities per reporter
y <- data.frame(x$fitted.values, stringsAsFactors=FALSE) %>% rownames_to_column()
names(y) <- c("row", "reporter_activity_predicted")
y$id <- 1:nrow(y)
prediction <- data.frame("id" = 1:(nrow(cDNA_df_p53_dmso)), stringsAsFactors=FALSE)
prediction <- merge(prediction,y, all = T) %>% 
  dplyr::select(-id)
cDNA_df_p53_dmso <- merge(cDNA_df_p53_dmso, prediction)
cDNA_df_p53_dmso$condition <- "DMSO"
  

# What are the individual weights?
weight <- data.frame(x$coefficients, stringsAsFactors=FALSE) %>% rownames_to_column() %>% na.omit()
names(weight) <- c("feature", "weight")
weight$feature[weight$feature == "(Intercept)"] <- "n_sites_spacing_dist1_7_0"
categorie <- c("affinity_pos1", "spacing")
weight$features <- gsub(paste(categorie, collapse="|"), "",weight$feature)
weight$cond <- gsub(paste(weight$features, collapse = "|"), "", weight$feature)
weight$cond[weight$cond == ""] <- "n_sites"
weight$condition <- "DMSO"



## Run the same model, but now for the Nutlin activity and not the FC
cDNA_df_p53_nutlin <- cDNA_df_p53
cDNA_df_p53_nutlin$row <- rownames(cDNA_df_p53_nutlin)

## Fitting the model
x <- lm(MCF7_WT_Nutlin ~ n_sites_spacing_dist, cDNA_df_p53_nutlin)

summ(x)
par(mfrow=c(2,2))
plot(x)

# Get predicted activities per reporter
y <- data.frame(x$fitted.values, stringsAsFactors=FALSE) %>% rownames_to_column()
names(y) <- c("row", "reporter_activity_predicted")
y$id <- 1:nrow(y)
prediction <- data.frame("id" = 1:(nrow(cDNA_df_p53_dmso)), stringsAsFactors=FALSE)
prediction <- merge(prediction,y, all = T) %>% 
  dplyr::select(-id)
cDNA_df_p53_nutlin <- merge(cDNA_df_p53_nutlin, prediction)
cDNA_df_p53_nutlin$condition <- "Nutlin"
cDNA_df_p53 <- rbind(cDNA_df_p53_nutlin, cDNA_df_p53_dmso)
  

# What are the individual weights?
weight_nutlin <- data.frame(x$coefficients, stringsAsFactors=FALSE) %>% rownames_to_column() %>% na.omit()
names(weight_nutlin) <- c("feature", "weight")
weight_nutlin$feature[weight_nutlin$feature == "(Intercept)"] <- "n_sites_spacing_dist1_7_0"
categorie <- c("affinity_pos1", "spacing")
weight_nutlin$features <- gsub(paste(categorie, collapse="|"), "",weight_nutlin$feature)
weight_nutlin$cond <- gsub(paste(weight_nutlin$features, collapse = "|"), "", weight_nutlin$feature)
weight_nutlin$cond[weight_nutlin$cond == ""] <- "n_sites"
weight_nutlin$condition <- "Nutlin"
weight <- rbind(weight, weight_nutlin)


# Plotting
ggplot(cDNA_df_p53 %>% filter(condition == "Nutlin"),
       aes(x = MCF7_WT_Nutlin, y = reporter_activity_predicted, color = n_sites)) +
  geom_smooth(color = "black", method = "lm") +
  geom_point(size = 2) +
  scale_color_manual(values = rev(reds)) +
  theme(legend.position = "none") +
  ylim(0,90)+
  xlim(0,90)

ggplot(cDNA_df_p53 %>% filter(condition == "DMSO"),
       aes(x = dif, y = reporter_activity_predicted, color = n_sites)) +
  geom_smooth(color = "black", method = "lm") +
  geom_point(size = 2) +
  scale_color_manual(values = rev(reds)) +
  theme(legend.position = "none")

level_order <- c("n_sites_spacing_dist1_7_0","n_sites_spacing_dist2_7_0","n_sites_spacing_dist2_7_1", "n_sites_spacing_dist3_7_0", "n_sites_spacing_dist3_7_1", "n_sites_spacing_dist4_0_0", "n_sites_spacing_dist4_1_0", 
                 "n_sites_spacing_dist4_2_0","n_sites_spacing_dist4_3_0", "n_sites_spacing_dist4_4_0","n_sites_spacing_dist4_5_0", "n_sites_spacing_dist4_6_0", "n_sites_spacing_dist4_7_0", "n_sites_spacing_dist4_8_0",
                 "n_sites_spacing_dist4_9_0", "n_sites_spacing_dist4_10_0","motif_dist")

ggplot(weight %>% filter(condition == "Nutlin"), 
       aes(x = factor(feature, level = level_order), y = weight)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.9, color = "white") + 
  ylab("weight - reporter activity") +
  xlab("") +
  #scale_fill_manual(values = colors_continous_2[c(1,3,5,6)]) +
  guides(fill = F)+
  theme_classic_lines_90()

ggplot(weight %>% filter(condition == "DMSO"), 
       aes(x = factor(feature, level = level_order), y = weight)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.9, color = "white") + 
  ylab("weight - reporter activity") +
  xlab("") +
  #scale_fill_manual(values = colors_continous_2[c(1,3,5,6)]) +
  guides(fill = F)+
  theme_classic_lines_90()
  
```

Conclusion: 

---

## Figure 5: Spacing follow-up

Aim: Can we proof that differences in BS spacing lead to differences in binding affinity?


```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}

```

Conlusion: 









# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

