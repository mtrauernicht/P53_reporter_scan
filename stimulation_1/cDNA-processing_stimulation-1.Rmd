---
title: "cDNA processing"
author: "Max Trauernicht"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: journal
    highlight: monochrome
    toc: yes
    toc_float: yes
    code_folding: show
  editor_options:
    chunk_output_type: console
  pdf_document:
    toc: yes
---

# knitr document van Steensel lab

# Introduction
I previously processed the raw sequencing data, quantified the pDNA data and normalized the cDNA data. In this script, I want to have a detailed look at the cDNA data from a general perspective.

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(RColorBrewer)
library(ggplot2)
library(dplyr)
library(maditr)
library(tibble)
library(pheatmap)
library(ggpubr)
library(ggbeeswarm)
library(ggforce)
library(viridis)
library(plyr)
library(cowplot)
library(gridExtra)
library(GGally)
library(readr)
library(stringr)
library(tidyr)
```

### Custom functions
Functions used thoughout this script.
```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}


cbind.fill <- function(...){
    nm <- list(...) 
    nm <- lapply(nm, as.matrix)
    n <- max(sapply(nm, nrow)) 
    do.call(cbind, lapply(nm, function (x) 
        rbind(x, matrix(, n-nrow(x), ncol(x))))) 
}

# Function to substring the right part of the motif
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}


# Function to load PWM matrix
get_pwm_feature_matrix <- function(motif_meta_fn, fimo_fn, db = 2) {

  # validate args
  valid_dbs <- 1:2
  if(!db %in% valid_dbs)
    stop('Invalid db (database version). Please use db=1 (maintained for backward compatibility only) or db=2')

  # db=1 is maintained for backward compatibility only
  if(db == 1) {

    # read in motif metadata
    motif_meta    <- read.csv(motif_meta_fn)

    # check whether motif metadata contain essential annotations
    if(!all(c('PWM.ID', 'Cognate.TF') %in% colnames(motif_meta))) {
      message('The motif metadata file does not contain the essential columns PWM.ID and Cognate.TF')
    }

    motif_minimal <- motif_meta[, c('PWM.ID', 'Cognate.TF')]

    # load fimo output --> extract motif id, sequence id and p-value
    df <- read.table(fimo_fn)
    df <- df[, c(1, 2, 7)]

    colnames(df) <- c('PWM.ID', 'seqid', 'pval')

    # add TF id
    df <- merge(df, motif_minimal, by = 'PWM.ID')

    # group motif hits by sequence id
    l <- split(df, df[['seqid']])

    # multiple PWM and multiple hits possible. Reduce hits to one per TF, keeping best p-val only
    l <- lapply(l, function(x) {
      x_by_tf <- split(x, x[['Cognate.TF']], drop = TRUE)
      x_by_tf <- lapply(x_by_tf, function(y) y[which.min(y$pval), ])
      do.call('rbind', x_by_tf)
    })

    # initialize feature matrix
    n_tf          <- motif_minimal[['Cognate.TF']] %>%
      unique %>%
      length
    n_seq         <- length(l)
    pwm           <- matrix(1, nrow = n_seq, ncol = n_tf)
    colnames(pwm) <- (motif_minimal[['Cognate.TF']] %>% unique)

    # replace :: from names of composite motifs
    colnames(pwm) <- str_replace_all(colnames(pwm), '::', '_')

    # fill in feature matrix
    for(i in 1 : n_seq) {
      pwm[i, l[[i]][['Cognate.TF']]] <- l[[i]]$pval
    }

    # -log10 transform
    pwm           <- -1 * log10(pwm)

    # coerce to tib and return
    tib_fimo <- as_data_frame(pwm) %>%
      mutate(id = names(l))
      dplyr::select(id, everything())

  }

  # db = 2 (default)
  else {

    # load metadata
    tib_meta    <- read_csv(motif_meta_fn) %>%
      # extract tf symbol from motif id (Cognate_TF unsafe, it can be empty) and replace :: occurrences
      mutate(tf_symbol = str_remove(ID, '_[0-9]*'),
             tf_symbol = str_replace(tf_symbol, '::', '_')) %>%
      select(motif_id = `PWM ID`, tf_symbol)

    # load fimo results
    tib_fimo <- read_tsv(fimo_fn) %>%
      # extract motif id, sequence id and p-value
      select(motif_id, sequence_name, pval = `p-value`)

    # add tf symbol to fimo results
    tib_fimo <- tib_fimo %>%
      left_join(tib_meta, by = 'motif_id') %>%
      # remove hits with missing motif id (composite pwms)
      filter(!is.na(tf_symbol))

    # select best hit for each motif and sequence
    tib_fimo <- tib_fimo %>%
      group_by(sequence_name, tf_symbol) %>%
      dplyr::slice(which.min(pval)) %>%
      ungroup()

    # spread into feature matrix
    tib_fimo <- tib_fimo %>%
      mutate(pval = -1 * log10(pval)) %>%
      select(-motif_id) %>%
      spread(key = tf_symbol, value = pval, fill = 0, drop = TRUE) %>%
      # perform cosmetics on the id
      mutate(id = sequence_name) %>%
      select(-c(sequence_name)) %>%
      select(id, everything())

  }

  return(tib_fimo)

}

# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {

  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y, "pairwise.complete.obs")
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)

  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }

  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())

  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]

  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }

  p <- p +
    theme(panel.background = element_rect(fill = corCol))

  return(p)
}

```


## Data import
```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
# Import processed bc counts from the preprocessing step
cDNA_df <- read.csv("/DATA/usr/m.trauernicht/projects/SuRE_deep_scan_trp53_gr/data/gcf6210/results/mt20201123_reporter_activity_filt.csv", header = T)
cDNA_df <- cDNA_df[!is.na(cDNA_df$tf),]

# Add annotations
## Mark O'Connell controls
cDNA_df$positive_ctrl <- "No"
cDNA_df$positive_ctrl[cDNA_df$position == 60 | cDNA_df$position == 70] <- "Yes"
cDNA_df$tf[cDNA_df$tf == "Trp53"] <- "P53"
cDNA_df$tf[cDNA_df$tf == "Gr"] <- "GR"
```

# Analysis

## First insights into data distribution - reporter activity distribution plots
```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## reporter activity distribution over all experiments
colors <- c("#1B998B", "#2D3047", "#FF9B71")

## reporter activity distribution for each experiment individually
ggplot(data = cDNA_df, aes(x = log_activity)) + 
  geom_density(fill = "#3D9F83") + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution") +
  xlim(-5,5) + theme_classic() + facet_wrap(vars(condition))

## Plot mean tf activity per condition
tf_activities <- data.frame("condition" = merge(unique(cDNA_df$condition), unique(cDNA_df$tf)),
                            "activity" = "") %>%
  setnames(c("condition.x", "condition.y"), c("condition", "TF"))

for(i in unique(cDNA_df$condition)) { 
  for (j in unique(cDNA_df$tf)){
    tf_activities$activity[tf_activities$condition == i & tf_activities$TF == j] <- 
      mean(cDNA_df$activity[cDNA_df$tf == j & cDNA_df$condition == i])
  }
}

plot_ly(tf_activities[-grep("random", tf_activities$TF),], 
        x = ~condition, y = ~as.numeric(activity), color = ~TF, type = 'bar',
             marker = list(line = list(color = 'rgb(8,48,107)', width = 1.5))) %>% 
  layout(title = "Mean TF activities per TF",
         xaxis = list(title = "condition"),
         yaxis = list(title = "log2 reporter activity"))


## reporter activity distribution - highlight negative motif controls
ggplot(cDNA_df, aes(x = log_activity, fill = neg_ctrls, alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - negative ctrls") +
  scale_fill_manual(values = colors) +
  xlim(-5,5) + theme_classic()+
  theme(text = element_text(size = 12))

## reporter activity distribution - highlight positive controls (O'Connell)
ggplot(cDNA_df, aes(x = log_activity, fill = positive_ctrl, alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - native enhancers") +
  scale_fill_manual(values = colors) +
  xlim(-5,5) + theme_classic()+ facet_wrap(vars(condition))


## reporter activity distribution - highlight different promoters
ggplot(cDNA_df, aes(x = log_activity, fill = promoter, alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - promoters") +
  scale_fill_brewer(palette = "Dark2") +
  xlim(-5,5) + theme_classic()

## highlight different tfs per condition
ggplot(cDNA_df[-grep("random",cDNA_df$tf),], aes(x = log_activity, fill = tf, alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - native enhancers") +
  scale_fill_brewer(palette = "Dark2") +
  xlim(0,5) + theme_classic()+ facet_wrap(vars(condition))


## reporter activity distribution - highlight different spacings
ggplot(cDNA_df[-grep("random",cDNA_df$tf),], aes(x = log_activity, fill = as.character(spacing), alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - spacings") +
  scale_fill_brewer(palette = "Paired") +
  xlim(-5,5) + theme_classic() + facet_wrap(vars(tf))

## reporter activity distribution - highlight different backgrounds
ggplot(cDNA_df[-grep("random",cDNA_df$tf),], aes(x = log_activity, fill = as.character(background), alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - spacings") +
  scale_fill_brewer(palette = "Paired") +
  xlim(-5,5) + theme_classic() + facet_wrap(vars(tf))

## reporter activity distribution - highlight different positions
ggplot(cDNA_df[-grep("random",cDNA_df$tf),], aes(x = log_activity, fill = as.character(position), alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - spacings") +
  scale_fill_brewer(palette = "Paired") +
  xlim(-5,5) + theme_classic() + facet_wrap(vars(tf))

## reporter activity distribution - highlight different affinities
ggplot(cDNA_df[-grep("random",cDNA_df$tf),], aes(x = log_activity, fill = as.character(affinity_pos1), alpha = 0.4)) + 
  geom_density() + xlab("log2(cDNA/pDNA)") + 
  labs(title = "reporter activity distribution - spacings") +
  scale_fill_brewer(palette = "Paired") +
  xlim(-5,5) + theme_classic() + facet_wrap(vars(tf))

## Mean activity per affinity at each position
x <- cDNA_df[-grep("random", cDNA_df$tf),]
aff_activities <- data.frame("condition" = merge(unique(x$condition), unique(x$tf)),
                            "activity" = "") %>%
  setnames(c("condition.x", "condition.y"), c("condition", "TF"))
affinity <- 1:4
aff_activities <- merge(aff_activities, affinity) %>% setnames("y", "affinity")

for(i in unique(x$condition)) { 
  for (j in unique(x$tf)){
    for(k in unique(aff_activities$affinity)) {
      aff_activities$activity[aff_activities$condition == i & aff_activities$TF == j & aff_activities$affinity == k] <- 
        mean(x$activity[x$tf == j & x$condition == i & x$affinity_pos1 == k])
    }
  }
}

ggplot(aff_activities[aff_activities$TF == "Gr",], aes(x = as.character(affinity), y = as.numeric(activity))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(colors) +
  theme_bw() + 
  xlab("affinity at position 1") +
  ylab("mean activity") +
  facet_wrap(~condition)

ggplot(aff_activities[aff_activities$TF == "P53",], aes(x = as.character(affinity), y = as.numeric(activity))) +
  geom_bar(stat = "identity") +
  scale_fill_manual(colors) +
  theme_bw() + 
  xlab("affinity at position 1") +
  ylab("mean activity") +
  facet_wrap(~condition)

## Activity vs. cumulative predicted affinity
affinity_df <- read.csv2("/DATA/usr/m.trauernicht/projects/SuRE_deep_scan_trp53_gr/data/library_design/mt20201123_affinity.csv", header = T)

for (i in unique(cDNA_df$affinity_pos1)) {
  for (j in unique(cDNA_df$affinity_pos2)) {
    for (k in unique(cDNA_df$affinity_pos3)) {
      for (l in unique(cDNA_df$affinity_pos4)) {
        for (m in unique(affinity_df$TF)) {
    cDNA_df$cum_affinity[cDNA_df$affinity_pos1 == i & cDNA_df$affinity_pos2 == j & cDNA_df$affinity_pos3 == k &
                         cDNA_df$affinity_pos4 == l & cDNA_df$tf == m] <- 
      affinity_df$affinity[affinity_df$id == i & affinity_df$TF == m] +
      affinity_df$affinity[affinity_df$id == j & affinity_df$TF == m] +
      affinity_df$affinity[affinity_df$id == k & affinity_df$TF == m] +
      affinity_df$affinity[affinity_df$id == l & affinity_df$TF == m]
        }
      }
    }
  }
}

cDNA_df <- cDNA_df %>%
  group_by(reporter_id) %>%
  mutate(ddG = affinity_pos1 + affinity_pos2 + affinity_pos3 + affinity_pos4,
         max_aff = max(affinity_pos1,affinity_pos2,affinity_pos3,affinity_pos4))


affinity_df <- cDNA_df[cDNA_df$tf == "P53" & cDNA_df$condition == "MCF7-WT_Nutlin" & cDNA_df$neg_ctrls == "No" &
                         cDNA_df$positive_ctrl == "No" & cDNA_df$rand_promoter == "No",] %>% 
  select(log_reporter_activity, ddG) %>%
  mutate(mean_activity = ave(log_reporter_activity, ddG, FUN = function(x) mean(x))) %>%
  select(-log_reporter_activity) %>% unique()
  
plot_ly(data = affinity_df, x = ~ddG, y = ~mean_activity) %>%
  add_markers(type = "scatter")

affinity_df <- cDNA_df[cDNA_df$tf == "P53" & cDNA_df$condition == "MCF7-WT_Nutlin" & cDNA_df$neg_ctrls == "No" &
                         cDNA_df$positive_ctrl == "No" & cDNA_df$rand_promoter == "No",] %>% 
  select(log_reporter_activity, max_aff) %>%
  mutate(mean_activity = ave(log_reporter_activity, max_aff, FUN = function(x) mean(x))) %>%
  select(-log_reporter_activity) %>% unique()

plot_ly(data = affinity_df, x = ~max_aff, y = ~mean_activity) %>%
  add_markers(type = "bar")
```




## Explain expression differences betweeen the different affinities
```{r out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE, message = FALSE}
## Subselect p53 only 
cDNA_df_p53 <- cDNA_df[cDNA_df$tf == "P53" &
                         cDNA_df$promoter == "mCMV" &
                         cDNA_df$position == 0 &
                         cDNA_df$spacing == 7 &
                         cDNA_df$background == 1 &
                         cDNA_df$neg_ctrls == "No" &
                         cDNA_df$positive_ctrl == "No",] %>%
  select(reporter_id, condition, log_reporter_activity, affinity_pos1, affinity_pos2, affinity_pos3, affinity_pos4) %>% unique()

#cDNA_df_p53 <- cDNA_df_p53[grep("MCF7-WT", cDNA_df_p53$condition),]

# Rename 0,1,2,3,4 in null, very-weak, weak, medium, strong
replace <- data.frame("old" = c(0:4), "new" = c("_4_strong", "_3_medium", "_2_weak", "_1_very-weak", "_0_null"))
for (i in unique(replace$old)) {
  cDNA_df_p53$affinity_pos1[cDNA_df_p53$affinity_pos1 == i] <- replace$new[replace$old == i]
  cDNA_df_p53$affinity_pos2[cDNA_df_p53$affinity_pos2 == i] <- replace$new[replace$old == i]
  cDNA_df_p53$affinity_pos3[cDNA_df_p53$affinity_pos3 == i] <- replace$new[replace$old == i]
  cDNA_df_p53$affinity_pos4[cDNA_df_p53$affinity_pos4 == i] <- replace$new[replace$old == i]
}

## Explain which affinities are essential at which position to boost activity
### Calculate expression variance
exp_variance <- data.frame("feature" = c(colnames(cDNA_df_p53 %>% select(-reporter_id, -condition, -log_reporter_activity)), "Residuals"))
prediction <- data.frame("id" = 1:(nrow(cDNA_df_p53)/length(unique(cDNA_df_p53$condition))))
weight <- data.frame("feature" = merge(colnames(cDNA_df_p53 %>% select(-reporter_id, -condition, -log_reporter_activity)), unique(cDNA_df_p53$affinity_pos1), all = T)) %>%
  mutate(feature = paste(feature.x, feature.y, sep = "")) %>% select("feature") %>% rbind("(Intercept)")
weight <- data.frame("feature"=weight[-grep("row", weight$feature),])

cDNA_df_p53$row <- rownames(cDNA_df_p53)



for (i in unique(cDNA_df_p53$condition)) {
  x <- lm(log_reporter_activity ~ affinity_pos1 +
            affinity_pos2 + affinity_pos3 + affinity_pos4, 
                     cDNA_df_p53[cDNA_df_p53$condition == i,])
  y <- data.frame(x$fitted.values) %>% rownames_to_column()
  par(mfrow=c(2,2))
  plot(x, main = i)
  names(y) <- c("row", i)
  y$id <- 1:nrow(y)
  prediction <- merge(prediction,y, all = T)
  
  w <- data.frame(x$coefficients) %>% rownames_to_column()
  names(w) <- c("feature", i)
  weight <- merge(weight,w, all = T)
  
  x <- anova(x) %>% rownames_to_column("feature") %>%
    setnames("Sum Sq", "sum_sq") %>%
    select(feature, sum_sq) %>%
    mutate(sum = sum(sum_sq)) %>%
    mutate(rel_sum_sq = (sum_sq/sum)*100) %>%
    setnames("rel_sum_sq", i)
  x <- x[,c(1,4)]
  
  exp_variance <- merge(exp_variance, x)
}


## Prepare lm parameters for plotting
exp_variance <- melt(exp_variance, variable.name = "condition")
exp_variance$group <- "no residual"
exp_variance$group[grep("Residual", exp_variance$feature)] <- "residual"
prediction <- prediction %>% select(-id) %>% melt(variable.name = "condition") %>% na.omit() %>%
  select(-condition) %>% setnames("value", "activity_predicted")
cDNA_df_p53 <- merge(cDNA_df_p53, prediction)
weight <- weight %>% filter(feature != "(Intercept)")
weight <- melt(weight, variable.name = "condition")
categorie <- "affinity_pos"
weight$features <- gsub(paste(categorie, collapse="|"), "",weight$feature)
feature <- weight$features
feature <- gsub("^.{1}", "", feature)
weight$cond <- gsub(paste(feature, collapse="|"), "", weight$feature)
weight$value[is.na(weight$value)] <- 0

# Further plotting preparations
exp_variance$value[exp_variance$feature == "Residuals"] <- 100 - exp_variance$value[exp_variance$feature == "Residuals"]
exp_variance$feature <- revalue(exp_variance$feature, c("Residuals"="total"))

# Plotting
ggplot(exp_variance, 
       aes(x = reorder(feature, -value), y = value, fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  ylab("Variance explained (%)") + xlab("") + 
  labs(title = "Linear variance modelling", 
       subtitle = "Expression variance predicted by features") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0, size = 12), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F) + facet_wrap(~condition)

ggscatter(cDNA_df_p53, x = "log_reporter_activity", y = "activity_predicted",
          add = "reg.line", 
          add.params = list(color = "blue", fill = "lightgray"),
          conf.int = TRUE, ylab = "Predicted log2-activity", size = 0.5,
          xlab = "Average log2-activity") + theme_bw() + facet_wrap(~condition) + 
  stat_cor(aes(label = ..r.label..), method = "pearson", label.x = 2, label.y = 1)

ggplot(weight, 
       aes(x = features, y = value, fill = cond)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047", "#FF9B71", "#ECDD7B", "#C2B2B4", "#A54657")) +
  ggtitle(i)+
  geom_bar(stat = "identity") + 
  ylab("Weight") + xlab("") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 10), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F) + 
  facet_wrap(~condition)
```
# This analysis favors a model in which position 4 is occupied by a strong p53 motif. Weak motifs upstream of this motif boost its activity. 









## Log-linear expression modelling to explain variance - model for each TF
```{r log-linear-model-3, out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE}
### For each TF separately - only the non-mutated 
cDNA_df_TF <- cDNA_df[cDNA_df$neg_ctrls == "No" &
                        cDNA_df$positive_ctrl == "No" &
                        cDNA_df$rand_promoter == "No",] %>% 
  mutate(log_reporter_activity = ave(log_reporter_activity, reporter_id, condition, FUN = function(x) mean(x))) %>%
  select(log_reporter_activity, tf, condition, promoter, spacing, background,
         position, affinity_pos1, affinity_pos2, affinity_pos3, affinity_pos4) %>%
  unique()

### Calculate expression variance
exp_variance <- data.frame(c("condition", "promoter", 
                             "spacing", "background", "position",
                             "affinity_pos1", "affinity_pos2", "affinity_pos3", "affinity_pos4", "Residuals"))
prediction <- data.frame(1:504)
names(prediction) <- "id"
names(exp_variance) <- "feature"
weight <- data.frame(c("(Intercept)", "conditionA549_Dex-100", "conditionA549_Dex-10", "conditionA549_Dex-1",
                       "conditionA549_DMSO", "conditionmES_N2B27-HQ", "conditionmES_N2B27-RA", 
                       "conditionMCF7-WT_Nutlin", "conditionMCF7-WT_DMSO", "conditionMCF7-KO_Nutlin", 
                       "promotermCMV", "promoterminP", "spacing5bp", "background2", "background3", "position1",
                       "position2", "position3", "position4", "position5", "position6", "position7", "position8",
                       "position9", "position10", "affinity_pos11", "affinity_pos12", "affinity_pos13", "affinity_pos14",
                       "affinity_pos21", "affinity_pos22", "affinity_pos23", "affinity_pos24", "affinity_pos31",
                       "affinity_pos32", "affinity_pos33", "affinity_pos34", "affinity_pos41", "affinity_pos42",
                       "affinity_pos43", "affinity_pos44"))
names(weight) <- "feature"


cDNA_df_TF$row <- rownames(cDNA_df_TF)



for (i in unique(cDNA_df_TF$tf)) {
  x <- lm(log_reporter_activity ~ condition + 
            promoter + spacing + background + position + affinity_pos1 +
            affinity_pos2 + affinity_pos3 + affinity_pos4, 
                     cDNA_df_TF[cDNA_df_TF$tf == i,])
  y <- data.frame(x$fitted.values) %>% rownames_to_column()
  par(mfrow=c(2,2))
  plot(x, main = i)
  names(y) <- c("row", i)
  y$id <- 1:nrow(y)
  prediction <- merge(prediction,y, all = T)
  
  w <- data.frame(x$coefficients) %>% rownames_to_column()
  names(w) <- c("feature", i)
  weight <- merge(weight,w, all = T)
  
  x <- anova(x) %>% rownames_to_column("feature") %>%
    setnames("Sum Sq", "sum_sq") %>%
    select(feature, sum_sq) %>%
    mutate(sum = sum(sum_sq)) %>%
    mutate(rel_sum_sq = (sum_sq/sum)*100) %>%
    setnames("rel_sum_sq", i)
  x <- x[,c(1,4)]
  
  exp_variance <- merge(exp_variance, x)
}


## Prepare lm parameters for plotting
exp_variance <- melt(exp_variance, variable.name = "tf")
exp_variance$group <- "no residual"
exp_variance$group[grep("Residual", exp_variance$feature)] <- "residual"
prediction <- prediction %>% select(-id) %>% melt(variable.name = "tf") %>% na.omit() %>%
  select(-tf) %>% setnames("value", "activity_predicted")
cDNA_df_TF <- merge(cDNA_df_TF, prediction)
weight <- weight %>% filter(feature != "(Intercept)")
weight <- melt(weight, variable.name = "tf")
categorie <- c("mutated", "condition", "promoter", 
               "spacing", "background","position", "affinity_pos1",
               "affinity_pos2", "affinity_pos3", "affinity_pos4")
weight$features <- gsub(paste(categorie, collapse="|"), "",weight$feature)
feature <- weight$features
weight$condition <- gsub(paste(feature, collapse="|"), "", weight$feature)
weight$value[is.na(weight$value)] <- 0


# Further plotting preparations
level_order <- c("A549_Dex-100","A549_Dex-10","A549_Dex-1","A549_Nutlin","A549_DMSO",
                 "mES_N2B27-HQ","mES_N2B27-RA","MCF7-WT_Nutlin","MCF7-WT_DMSO","MCF7-KO_Nutlin",
                 "mCMV", "minP", "2", "3", "10bp", "1", "2", "3", "4", "5", "6", "7", "8", "9",
                 "1", "2", "3", "4", "1", "2", "3", "4", "1", "2", "3", "4")


# Model parameters
exp_variance$value[exp_variance$feature == "Residuals"] <- 100 - exp_variance$value[exp_variance$feature == "Residuals"]
exp_variance$feature <- revalue(exp_variance$feature, c("Residuals"="total"))



ggplot(exp_variance, 
       aes(x = reorder(feature, -value), y = value, fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  ylab("Variance explained (%)") + xlab("") + 
  labs(title = "Linear variance modelling", 
       subtitle = "Expression variance predicted by features") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0, size = 12), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F) + facet_wrap(~tf)

ggscatter(cDNA_df_TF, x = "log_reporter_activity", y = "activity_predicted",
          add = "reg.line", 
          add.params = list(color = "blue", fill = "lightgray"),
          conf.int = TRUE, ylab = "Predicted log2-activity", size = 0.5,
          xlab = "Average log2-activity") + theme_bw() + facet_wrap(~tf) + 
  stat_cor(aes(label = ..r.label..), method = "pearson", label.x = -2, label.y = 4)



for (i in unique(cDNA_df_TF$tf)) {
  
  # Plot to show prediction accuracy
  sp <- ggscatter(cDNA_df_TF[cDNA_df_TF$tf == i,], x = "log_reporter_activity", y = "activity_predicted",
   add = "reg.line", 
   add.params = list(color = "blue", fill = "lightgray"),
   conf.int = TRUE, ylab = "Predicted log2-activity", 
   title = i,
   xlab = "Average log2-activity") + theme_bw()
  
  
  # Feature importance overview for each TF (including mean activities per feature)
  fp <- ggplot(exp_variance[exp_variance$tf == i,], 
       aes(x = reorder(feature, -value), y = value, fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  ylab("Variance explained (%)") + xlab("") +
  ggtitle(i)+
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0, size = 12), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F)
  
  # Plot weights of parameters in model - this helps to understand the model 
  p <- ggplot(weight[weight$tf == i,], 
       aes(x = factor(features, level = level_order), y = value, fill = condition)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047", "#FF9B71", "#ECDD7B", "#C2B2B4", "#A54657")) +
  ggtitle(i)+
  geom_bar(stat = "identity") + 
  ylab("Weight") + xlab("") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 10), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F) 

  # Combine all plots
  sp.plot <- arrangeGrob(sp,fp,p, nrow = 2, ncol = 2)
  grid.arrange(sp.plot)
}
```


















## Log-linear expression modelling to explain variance - model for each TF - only WT - without condition
```{r log-linear-model-4, out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE}
### For each TF separately - only the non-mutated 
cDNA_df_TF <- cDNA_df[cDNA_df$native_enhancer == "No" &
                        cDNA_df$hPGK == "No" & 
                        cDNA_df$neg_ctrls == "No" &
                        cDNA_df$TF != "Random1"&
                        cDNA_df$TF != "Random2"&
                        cDNA_df$TF != "Random3",] %>% 
  mutate(log_reporter_activity = ave(log_reporter_activity, reporter_id, FUN = function(x) mean(x))) %>%
  select(log_reporter_activity, TF, Promoter, Spacing, Distance, Background) %>%
  unique()

cDNA_df_rel <- cDNA_df_ctrl[cDNA_df_ctrl$neg_ctrls == "No",] %>% 
  mutate(TF = gsub("(^.*)_[0-9]{1,2}bp_[0-9]{1,2}bp_.*", "\\1", reporter_2),
         Promoter = gsub(".*(minP|mCMV|hBGm|Random)_.*", "\\1", reporter_2),
         Distance = gsub(".*_([0-9]{1,2}bp)_.*", "\\1", reporter_2),
         Spacing = gsub(".*_([0-9]{1,2}bp)_[0-9]{1,2}bp_.*", "\\1", reporter_2),
         Background = gsub(".*([0-9]{1}$)", "\\1", reporter_2)) %>%
  select(log_reporter_activity_relative, TF, Promoter, Distance, Spacing, Background) %>% unique() %>%
  mutate(log_reporter_activity_relative = ave(log_reporter_activity_relative, 
                                              TF, Promoter, Distance, Spacing, Background, 
                                              FUN = function(x) mean(x)))

cDNA_df_TF <- merge(cDNA_df_TF, cDNA_df_rel, all = T)



### Calculate expression variance
exp_variance <- data.frame(c("Promoter", "Spacing", "Distance", "Background", "Residuals"))
prediction <- data.frame(1:504)
names(prediction) <- "id"
names(exp_variance) <- "feature"
weight <- data.frame(c("(Intercept)", "PromotermCMV", "PromoterminP", 
                  "Spacing5bp", "Distance21bp", "Background2", "Background3"))
names(weight) <- "feature"


cDNA_df_TF$row <- rownames(cDNA_df_TF)

for (i in unique(cDNA_df_TF$TF)) {
  x <- lm(log_reporter_activity ~ Promoter + Spacing + Distance + Background, 
                     cDNA_df_TF[cDNA_df_TF$TF == i,])
  y <- data.frame(x$fitted.values) %>% rownames_to_column()
  names(y) <- c("row", i)
  y$id <- 1:nrow(y)
  prediction <- merge(prediction,y, all = T)
  
  w <- data.frame(x$coefficients) %>% rownames_to_column()
  names(w) <- c("feature", i)
  weight <- merge(weight,w, all = T)
  
  x <- anova(x) %>% rownames_to_column("feature") %>%
    setnames("Sum Sq", "sum_sq") %>%
    select(feature, sum_sq) %>%
    mutate(sum = sum(sum_sq)) %>%
    mutate(rel_sum_sq = (sum_sq/sum)*100) %>%
    setnames("rel_sum_sq", i)
  x <- x[,c(1,4)]
  
  exp_variance <- merge(exp_variance, x)
}


## Fine-tune dfs
exp_variance <- melt(exp_variance, variable.name = "TF")
exp_variance$group <- "no residual"
exp_variance$group[grep("Residual", exp_variance$feature)] <- "residual"
prediction <- prediction %>% select(-id) %>% melt(variable.name = "TF") %>% na.omit() %>%
  select(-TF) %>% setnames("value", "activity_predicted")
cDNA_df_TF <- merge(cDNA_df_TF, prediction)
weight <- weight %>% filter(feature != "(Intercept)")
weight <- melt(weight, variable.name = "TF")
categorie <- c("mutated", "condition", "Promoter", 
               "Spacing", "Distance", "Background")
weight$features <- gsub(paste(categorie, collapse="|"), "",weight$feature)
feature <- weight$features
weight$condition <- gsub(paste(feature, collapse="|"), "", weight$feature)
weight <- weight %>% select(-feature)



# Model parameters
exp_variance$value[exp_variance$feature == "Residuals"] <- 100 - exp_variance$value[exp_variance$feature == "Residuals"]
exp_variance$feature <- revalue(exp_variance$feature, c("Residuals"="total"))

ggplot(exp_variance, 
       aes(x = reorder(feature, -value), y = value, fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  ylab("Variance explained (%)") + xlab("") + 
  labs(title = "Linear variance modelling", 
       subtitle = "Expression variance predicted by features") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0, size = 12), 
        axis.text.y = element_text(size = 10)) +
  facet_wrap(~TF)




## Plot weights of parameters in model - this helps to understand the model 
level_order <- c("mCMV", "minP","Random", 
                 "2", "3", "5bp", "21bp")





## Final overview - model fit for each TF
# Feature importance overview for each TF in a single plot (bar-chart including mean activities per feature)


for (i in unique(cDNA_df_TF$TF)) {
  
  # Plot to show prediction accuracy
  sp <- ggscatter(cDNA_df_TF[cDNA_df_TF$TF == i,], x = "log_reporter_activity", y = "activity_predicted",
   add = "reg.line", 
   add.params = list(color = "blue", fill = "lightgray"),
   conf.int = TRUE, ylab = "Predicted log2-activity", 
   title = i,
   xlab = "Average log2-activity") + theme_bw()
  
  
  # Feature importance overview for each TF (including mean activities per feature)
  fp <- ggplot(exp_variance[exp_variance$TF == i,], 
       aes(x = reorder(feature, -value), y = value, fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  ylab("Variance explained (%)") + xlab("") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0, size = 12), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F)
  
  # Plot weights of parameters in model - this helps to understand the model 
  p <- ggplot(weight[weight$TF == i,], 
       aes(x = factor(features, level = level_order), y = value, fill = condition)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047", "#FF9B71", "#ECDD7B", "#C2B2B4", "#A54657")) +
  geom_bar(stat = "identity") + 
  ylab("Weight") + xlab("") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 10), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F) 

  # Combine all plots
  sp.plot <- arrangeGrob(sp,fp,p, nrow = 2, ncol = 2)
  grid.arrange(sp.plot)
}
```





## Can expression variance be explained by the TF properties?
```{r tf-properties, out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE}
# # Import tf properties dataframe
# tf_properties <- read.csv2("/DATA/usr/m.trauernicht/projects/tf_activity_reporter/data/SuRE_TF_1/tf_properties.csv", header = T)
# tf_properties_lamb <- read.csv2("/DATA/usr/m.trauernicht/projects/tf_activity_reporter/data/complete_TF_motif_space/lambert_filt.csv", header = T) %>% setnames("Name", "TF") %>% select(TF, DBD)
# 
# tf_properties <- merge(tf_properties, tf_properties_lamb)
# 
# convertletter <- function(x) {
#   substr(x, 2, 20) <- tolower(substr(x, 2, 20))
#   x
# }
# 
# tf_properties$TF <- convertletter(tf_properties$TF)
# 
# tf_properties <- tf_properties[tf_properties$TF %in% cDNA_df$TF,]
# 
# variance <- exp_variance[exp_variance$feature == "total",] %>% select(TF, value) %>% unique()
# 
# expression <- cDNA_df_TF %>% select(log_reporter_activity_relative, TF) %>% 
#   mutate(log_reporter_activity_relative = ave(log_reporter_activity_relative, TF, FUN = function(x) mean(x))) %>%
#   unique()
# 
# tf_properties <- merge(tf_properties, variance)
# tf_properties <- merge(tf_properties, expression)
# 
# x1 <- ggplot(tf_properties, aes(x = chromatin_regulation_mode, y = value)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   xlab("Chromatin regulation mode") +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   ylab("TF reporter quality")
# 
# x2 <- ggplot(tf_properties, aes(x = chromatin_regulation_mode, y = log_reporter_activity_relative)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   xlab("Chromatin regulation mode") +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   ylab("TF reporter expression")
# 
# 
# #Grid the plots to one panel
# sp.plot <- arrangeGrob(x1,x2, nrow = 1, ncol = 2)
# grid.arrange(sp.plot)
# 
# 
# y1 <- ggplot(tf_properties, aes(x = TF_superclass, y = value)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   xlab("TF superclass") +
#   ylab("TF reporter quality")
# 
# y2 <- ggplot(tf_properties, aes(x = TF_superclass, y = log_reporter_activity_relative)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   xlab("TF superclass") +
#   ylab("TF reporter expression")
# 
# sp.plot <- arrangeGrob(y1,y2, nrow = 1, ncol = 2)
# grid.arrange(sp.plot)
# 
# 
# z1 <- ggplot(tf_properties, aes(x = mode_of_regulation, y = value)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   xlab("Mode of regulation") +
#   ylab("TF reporter quality")
# 
# z2 <- ggplot(tf_properties, aes(x = mode_of_regulation, y = log_reporter_activity_relative)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   xlab("Mode of regulation") +
#   ylab("TF reporter expression")
# 
# sp.plot <- arrangeGrob(z1,z2, nrow = 1, ncol = 2)
# grid.arrange(sp.plot)
# 
# 
# x4 <- ggplot(tf_properties, aes(x = tissue_of_expression, y = value)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   xlab("Tissue specificity") +
#   ylab("TF reporter quality")
# 
# x5 <- ggplot(tf_properties, aes(x = tissue_of_expression, y = log_reporter_activity_relative)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   xlab("Tissue specificity") +
#   ylab("TF reporter expression")
# 
# sp.plot <- arrangeGrob(x4,x5, nrow = 1, ncol = 2)
# grid.arrange(sp.plot)
# 
# 
# x6 <- ggplot(tf_properties, aes(x = DBD, y = value)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   xlab("DNA binding domain") +
#   ylab("TF reporter quality")
# 
# x7 <- ggplot(tf_properties, aes(x = DBD, y = log_reporter_activity_relative)) +
#   geom_quasirandom(width = 0.2) +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+
#   xlab("DNA binding domain") +
#   ylab("TF reporter expression")
# 
# sp.plot <- arrangeGrob(x6,x7, nrow = 1, ncol = 2)
# grid.arrange(sp.plot)
# 

```





## Finding the best reporters for a single TF
## Make the same models as before - but now per TF and per condition
```{r log-linear-model-5, out.width= "100%", fig.align= "center", echo=FALSE, warning= FALSE}
### For each TF separately - only the non-mutated 
cDNA_df_TF <- cDNA_df[cDNA_df$native_enhancer == "No" &
                        cDNA_df$hPGK == "No" & 
                        cDNA_df$neg_ctrls == "No" &
                        cDNA_df$TF != "Random1"&
                        cDNA_df$TF != "Random2"&
                        cDNA_df$TF != "Random3",] %>% 
  mutate(log_reporter_activity = ave(log_reporter_activity, reporter_id, condition, FUN = function(x) mean(x)),
         TF = paste(TF, condition, sep = "_")) %>%
  select(log_reporter_activity, TF, Promoter, Spacing, Distance, Background) %>%
  unique()

cDNA_df_rel <- cDNA_df_ctrl[cDNA_df_ctrl$neg_ctrls == "No",] %>% 
  mutate(TF = gsub("(^.*)_[0-9]{1,2}bp_[0-9]{1,2}bp_.*", "\\1", reporter_2),
         tf = paste(TF, condition, sep = "_"),
         Promoter = gsub(".*(minP|mCMV|hBGm|Random)_.*", "\\1", reporter_2),
         Distance = gsub(".*_([0-9]{1,2}bp)_.*", "\\1", reporter_2),
         Spacing = gsub(".*_([0-9]{1,2}bp)_[0-9]{1,2}bp_.*", "\\1", reporter_2),
         Background = gsub(".*([0-9]{1}$)", "\\1", reporter_2)) %>%
  select(log_reporter_activity_relative, tf, Promoter, Distance, Spacing, Background) %>% unique() %>%
  mutate(log_reporter_activity_relative = ave(log_reporter_activity_relative, 
                                              tf, Promoter, Distance, Spacing, Background, 
                                              FUN = function(x) mean(x))) %>%
  setnames("tf", "TF")

cDNA_df_TF <- merge(cDNA_df_TF, cDNA_df_rel, all = T)



### Calculate expression variance
exp_variance <- data.frame(c("Promoter", "Spacing", "Distance", "Background", "Residuals"))
prediction <- data.frame(1:504)
names(prediction) <- "id"
names(exp_variance) <- "feature"
weight <- data.frame(c("(Intercept)", "PromotermCMV", "PromoterminP", 
                  "Spacing5bp", "Distance21bp", "Background2", "Background3"))
names(weight) <- "feature"


cDNA_df_TF$row <- rownames(cDNA_df_TF)
cDNA_df_TF <- cDNA_df_TF[cDNA_df_TF$Promoter != "Random",]


for (i in unique(cDNA_df_TF$TF)) {
  if (length(cDNA_df_TF[cDNA_df_TF$TF == i,] > 1)) {
    x <- lm(log_reporter_activity_relative ~ Promoter + Spacing + Distance + Background, 
                     cDNA_df_TF[cDNA_df_TF$TF == i,])
    y <- data.frame(x$fitted.values) %>% rownames_to_column()
    names(y) <- c("row", i)
    y$id <- 1:nrow(y)
    prediction <- merge(prediction,y, all = T)
  
    w <- data.frame(x$coefficients) %>% rownames_to_column()
    names(w) <- c("feature", i)
    weight <- merge(weight,w, all = T)
  
    x <- anova(x) %>% rownames_to_column("feature") %>%
      setnames("Sum Sq", "sum_sq") %>%
      select(feature, sum_sq) %>%
      mutate(sum = sum(sum_sq)) %>%
      mutate(rel_sum_sq = (sum_sq/sum)*100) %>%
      setnames("rel_sum_sq", i)
    x <- x[,c(1,4)]
  
    exp_variance <- merge(exp_variance, x)
  }
}


## Fine-tune dfs
exp_variance <- melt(exp_variance, variable.name = "TF")
exp_variance$group <- "no residual"
exp_variance$group[grep("Residual", exp_variance$feature)] <- "residual"
prediction <- prediction %>% select(-id) %>% melt(variable.name = "TF") %>% na.omit() %>%
  select(-TF) %>% setnames("value", "activity_predicted")
cDNA_df_TF <- merge(cDNA_df_TF, prediction)
weight <- weight %>% filter(feature != "(Intercept)")
weight <- melt(weight, variable.name = "TF")
categorie <- c("mutated", "condition", "Promoter", 
               "Spacing", "Distance", "Background")
weight$features <- gsub(paste(categorie, collapse="|"), "",weight$feature)
ml <- length(weight$features)
feature <- weight$features
weight$condition <- gsub(paste(head(feature, n = ml/4), collapse = "|"), "", weight$feature)
weight <- weight %>% select(-feature)



# Model parameters
exp_variance$value[exp_variance$feature == "Residuals"] <- 100 - exp_variance$value[exp_variance$feature == "Residuals"]
exp_variance$feature <- revalue(exp_variance$feature, c("Residuals"="total"))

ggplot(exp_variance[grep("P53", exp_variance$TF),], 
       aes(x = reorder(feature, -value), y = value, fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  ylab("Variance explained (%)") + xlab("") + 
  labs(title = "Linear variance modelling", 
       subtitle = "Expression variance predicted by features") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0, size = 12), 
        axis.text.y = element_text(size = 10)) +
  facet_wrap(~TF)




## Plot weights of parameters in model - this helps to understand the model 
level_order <- c("mCMV", "minP","Random", 
                 "2", "3", "5bp", "21bp")





## Final overview - model fit for each TF
# Feature importance overview for each TF in a single plot (bar-chart including mean activities per feature)


for (i in unique(cDNA_df_TF$TF[grep("Nfe2l2", cDNA_df_TF$TF)])) {
  
  # Plot to show prediction accuracy
  sp <- ggscatter(cDNA_df_TF[cDNA_df_TF$TF == i,], x = "log_reporter_activity", y = "activity_predicted",
   add = "reg.line", 
   add.params = list(color = "blue", fill = "lightgray"),
   conf.int = TRUE, ylab = "Predicted log2-activity", 
   title = i,
   xlab = "Average log2-activity") + theme_bw()
  
  
  # Feature importance overview for each TF (including mean activities per feature)
  fp <- ggplot(exp_variance[exp_variance$TF == i,], 
       aes(x = reorder(feature, -value), y = value, fill = group)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047")) +
  geom_bar(stat = "identity") + 
  ylab("Variance explained (%)") + xlab("") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0, size = 12), 
        axis.text.y = element_text(size = 10)) +
    guides(fill = F)
  
  # Plot weights of parameters in model - this helps to understand the model 
  p <- ggplot(weight[weight$TF == i,], 
       aes(x = factor(features, level = level_order), y = value, fill = condition)) +
  scale_fill_manual(values = c("#1B998B", "#2D3047", "#FF9B71", "#ECDD7B", "#C2B2B4", "#A54657")) +
  geom_bar(stat = "identity") + 
  ylab("Weight") + xlab("") +
  theme_bw() +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1, size = 10), 
        axis.text.y = element_text(size = 10)) 

  # Combine all plots
  sp.plot <- arrangeGrob(sp,fp,p, nrow = 2, ncol = 2)
  grid.arrange(sp.plot)
}
```














## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

